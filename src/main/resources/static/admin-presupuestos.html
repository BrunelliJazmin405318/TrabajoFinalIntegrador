<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin | Presupuestos </title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- <link href="/css/styles.css" rel="stylesheet"> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --recti-red: #e53935;
            --recti-red-dark: #c62828;
            --recti-black: #111111;
            --recti-white: #ffffff;
            --recti-bg-light: #f3f3f3;
            --recti-card-light: #ffffff;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--recti-bg-light) url("/img/fondo-figura.png") repeat;
            background-size: 260px;
            color: var(--recti-black);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== MINI NAV SUPERIOR ADMIN ===== */
        .mini-nav {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .mini-nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: .45rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: .85rem;
        }

        .mini-nav-left a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: .25rem .7rem;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,0.08);
            background: #fff;
            text-decoration: none;
            color: #222;
        }

        .mini-nav-left a i {
            font-size: 1.1rem;
        }

        .mini-nav-pill {
            padding: .25rem .7rem;
            border-radius: 999px;
            background: #111;
            color: white;
            font-size: .8rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* ===== PAGE WRAP ===== */
        main.page-wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 16px 40px;
            flex: 1 0 auto;
            width: 100%;
        }

        .page-header {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .page-header-left h1 {
            margin: 0;
            font-size: 1.9rem;
            font-weight: 700;
            letter-spacing: .03em;
        }

        .page-header-left p {
            margin: 4px 0 0;
            font-size: .95rem;
            color: #555;
        }

        .badge-admin {
            background: var(--recti-red);
            color: #fff;
            padding: .35rem .75rem;
            border-radius: 999px;
            font-size: .78rem;
            text-transform: uppercase;
            letter-spacing: .06em;
        }

        .badge-api {
            background: #29b6f6;
            color: #fff;
            padding: .35rem .75rem;
            border-radius: 999px;
            font-size: .78rem;
            text-transform: uppercase;
            letter-spacing: .06em;
        }

        /* ===== CARDS ===== */
        .card {
            border-radius: 16px;
            background: rgba(255,255,255,0.96);
            border: 1px solid rgba(0,0,0,0.04);
            box-shadow: 0 12px 30px rgba(0,0,0,0.08);
        }

        .card-filters,
        .card-gen {
            margin-bottom: 16px;
            animation: fadeIn .4s ease-out;
        }

        .card-table {
            animation: fadeIn .5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ===== TABLE ===== */
        table.table thead th {
            font-size: .8rem;
            text-transform: uppercase;
            letter-spacing: .06em;
            color: #555;
            border-bottom-width: 1px;
        }

        table.table tbody td {
            font-size: .87rem;
            vertical-align: middle;
        }

        .table thead tr {
            background: #fafafa;
        }

        .table-hover > tbody > tr:hover > * {
            background-color: #f7f7f7;
        }

        /* ===== BANNERS FLOATING (toastContainer) ===== */
        #toastContainer .alert {
            border-radius: 999px;
        }

        /* ===== BOTONES / FORM ===== */
        #btnBuscar {
            border-radius: 999px;
            background-color: #c62828;
            border: none;
        }

        #btnBuscar:hover {
            background-color: #b71c1c;
        }

        #fEstado,
        #fSolicitud {
            border-radius: 999px;
        }

        /* chips de servicios */
        #serviciosGrid .btn,
        #extrasChips .btn {
            border-radius: 999px;
            color: var(--recti-red-dark);
        }

        /* ===== FOOTER ===== */
        footer.site-footer {
            border-top: 1px solid rgba(0,0,0,0.06);
            padding: 12px 16px;
            font-size: .8rem;
            color: #666;
            background: rgba(255,255,255,0.9);
        }

        footer .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* CARD TABLE SCROLLEABLE (si quer√©s limitar alto, se puede activar) */
        /* .table-scroll {
            max-height: 60vh;
            overflow-y: auto;
        } */
        /* ===== TOQUES ROJOS SUAVES ===== */

        /* Solo el bot√≥n "Generar" en rojo */
        .card-gen .btn-primary {
            background-color: var(--recti-red);
            border-color: var(--recti-red);
        }

        .card-gen .btn-primary:hover,
        .card-gen .btn-primary:focus {
            background-color: var(--recti-red-dark);
            border-color: var(--recti-red-dark);
        }

        /* Chips de servicios y extras */
        #serviciosGrid .btn,
        #extrasChips .btn {
            border-radius: 999px;
            color: var(--recti-red-dark);   /* texto rojo */
            /* el borde queda azul por defecto de Bootstrap (outline-primary) */
        }

        /* Chips seleccionados: fondo rojo */
        #serviciosGrid .btn.btn-primary,
        #extrasChips .btn.btn-primary {
            background-color: var(--recti-red);
            border-color: var(--recti-red);
            color: #fff;
        }
        /* ===== ACCIONES EN TABLA DE PRESUPUESTOS ===== */
        .tabla-presupuestos tbody tr {
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }

        .tabla-presupuestos tbody tr:last-child {
            border-bottom: none;
        }
        .tabla-presupuestos td:last-child {
            display: flex;
            flex-wrap: wrap;
            gap: .25rem .5rem;          /* espacio entre chips */
            align-items: flex-start;
            white-space: normal;        /* permite saltos de l√≠nea */
        }

        /* Quitamos los m√°rgenes horizontales de Bootstrap dentro de la celda */
        .tabla-presupuestos td:last-child > * {
            margin: 0 !important;
        }

        /* Chips un poquito m√°s chicos para que no se sature */
        .tabla-presupuestos td:last-child .badge {
            font-size: .72rem;
            padding: .2rem .45rem;
        }

        .tabla-presupuestos td:last-child .btn-sm {
            font-size: .78rem;
            padding: .2rem .5rem;
        }

        /* Separar bloque de OT para que se lea mejor */
        .tabla-presupuestos td:last-child div.mt-2 {
            width: 100%;               /* que corte a otra l√≠nea */
            margin-top: .3rem !important;
        }
        /* === Tabla scrolleable y header fijo === */
        .card-table {
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 12px 30px rgba(0,0,0,.12);
        }

        .table-scroll {
            max-height: 60vh;
            overflow-y: auto;
        }

        .table-scroll thead th {
            position: sticky;
            top: 0;
            z-index: 2;
            background: #fafafa;
        }

        /* === Columna de acciones compacta === */
        .col-acciones {
            white-space: nowrap;
            font-size: .8rem;
        }

        /* Botoncitos redondos con iconos */
        .btn-icon-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Pila de acciones */
        .acciones-stack {
            display: flex;
            flex-direction: column;
            gap: .25rem;
        }

        .acciones-stack .acciones-line {
            display: flex;
            flex-wrap: wrap;
            gap: .25rem .35rem;
            align-items: center;
        }

    </style>
</head>
<body>

<!-- MINI NAV SUPERIOR -->
<div class="mini-nav">
    <div class="mini-nav-inner">
        <div class="mini-nav-left">
            <a href="/admin-menu.html">
                <i class="bi bi-arrow-left-short"></i> Volver al panel
            </a>
        </div>
        <div class="mini-nav-right">
            <span class="mini-nav-pill">
                <i class="bi bi-receipt-cutoff"></i> Presupuestos
            </span>
        </div>
    </div>
</div>

<!-- BANNER FLOATING TOP -->
<div id="toastContainer"
     class="position-fixed top-0 start-50 translate-middle-x p-3"
     style="z-index:3000; width:100%; max-width:430px;">
</div>

<main class="page-wrap">
    <!-- HEADER -->
    <header class="page-header">
        <div class="page-header-left">
            <h1>Presupuestos</h1>
            <p>Gener√°, gestion√° y factur√° los presupuestos aprobados desde la web.</p>
        </div>
        <div class="page-header-right d-flex flex-wrap gap-2">
            <span class="badge-admin">Panel admin</span>
        </div>
    </header>

    <!-- Generaci√≥n r√°pida -->
    <div class="card card-gen mb-3">
        <div class="card-body">
            <h5 class="card-title mb-3">
                <i class="bi bi-magic me-2 text-danger"></i>
                Generar presupuesto desde solicitud aprobada
            </h5>

            <form id="gen" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">Solicitud ID</label>
                    <input class="form-control" name="solicitudId" required>
                    <div id="solicitudInfo" class="form-text text-muted"></div>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Tipo veh√≠culo</label>
                    <select class="form-select" name="vehiculoTipo" required>
                        <option value="CONVENCIONAL">Convencional</option>
                        <option value="IMPORTADO">Importado</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label d-block">Pieza</label>
                    <div class="btn-group d-flex" role="group" aria-label="piezaTipo">
                        <input type="radio" class="btn-check" name="piezaTipo" id="piezaMotor" value="MOTOR" autocomplete="off" checked data-lockable>
                        <label class="btn btn-outline-primary" for="piezaMotor">Motor</label>

                        <input type="radio" class="btn-check" name="piezaTipo" id="piezaTapa" value="TAPA" autocomplete="off" data-lockable>
                        <label class="btn btn-outline-primary" for="piezaTapa">Tapa</label>
                    </div>
                </div>

                <div class="col-12">
                    <label class="form-label d-block">Servicios</label>

                    <!-- GRILLA de chips -->
                    <div id="serviciosGrid" class="row g-2"></div>

                    <!-- Agregar otro -->
                    <div class="input-group mt-3" style="max-width: 560px;">
                        <input id="srvOtro" type="text" class="form-control" placeholder="Agregar otro servicio‚Ä¶">
                        <input id="srvOtroPrecio" type="number" class="form-control" placeholder="Precio ($)" min="0" step="0.01" style="max-width: 150px;">
                        <button id="btnSrvOtro" class="btn btn-outline-secondary" type="button">
                            <i class="bi bi-plus-lg"></i> Agregar
                        </button>
                    </div>
                    <div class="form-text">Hac√© click en un servicio para seleccionarlo. Pod√©s agregar servicios personalizados con su precio.</div>
                </div>

                <div class="col-md-3 d-grid mt-2">
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-clipboard-plus me-1"></i> Generar
                    </button>
                </div>
            </form>

            <div id="genOk"  class="alert alert-success mt-3 d-none"></div>
            <div id="genErr" class="alert alert-danger  mt-3 d-none"></div>
        </div>
    </div>

    <!-- FILTROS LISTADO -->
    <div class="card card-filters mb-3">
        <div class="card-body">
            <h6 class="mb-3 text-uppercase text-muted" style="letter-spacing:.09em; font-size:.78rem;">
                Filtrar presupuestos
            </h6>
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label for="fEstado" class="form-label small mb-1">Estado</label>
                    <select id="fEstado" class="form-select">
                        <option value="">Todos</option>
                        <option value="PENDIENTE" selected>Pendientes</option>
                        <option value="APROBADO">Aprobados</option>
                        <option value="RECHAZADO">Rechazados</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="fSolicitud" class="form-label small mb-1">Filtrar por Solicitud ID</label>
                    <input id="fSolicitud" class="form-control" placeholder="Ej: 15">
                </div>
                <div class="col-md-2 d-grid">
                    <button id="btnBuscar" class="btn btn-secondary mt-3 mt-md-0">
                        <i class="bi bi-search me-1"></i> Buscar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLA -->
    <div class="card card-table">
        <div class="card-body p-0">
            <div class="d-flex justify-content-between align-items-center p-3 pb-2">
                <h6 class="mb-0 text-uppercase text-muted" style="letter-spacing:.09em; font-size:.78rem;">
                    Listado
                </h6>
                <small class="text-secondary">ID, solicitud, cliente, tipo, total, estado y acciones.</small>
            </div>

            <div class="table-responsive table-scroll">
                <table class="table table-bordered align-middle mb-0 table-hover tabla-presupuestos">
                    <thead class="sticky-header">
                    <tr>
                        <th>ID</th>
                        <th>Solicitud</th>
                        <th>Cliente</th>
                        <th>Tipo</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th>Creada</th>
                        <th class="col-acciones">Acciones</th>
                    </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<footer class="site-footer">
    <div class="footer-inner">
        <span>¬© 2025 Rectificadora Cornejo</span>
        <span>Panel administrativo ‚Äî UTN FRC</span>
    </div>
</footer>

<script type="module">
    import { getAuthHeader, isAuthenticated } from "/js/auth.js";

    // ======= Config =======
    const ENDPOINT_PM = "/admin/pagos-manuales/registrar";
    const ENDPOINT_PDF_BY_PRES = (id, tipo = "B") =>
        `/admin/facturas/pdf/by-presupuesto/${id}?tipo=${encodeURIComponent(tipo)}`;
    const ENDPOINT_FACTURAR = (id) => `/admin/facturas/generar/${id}`;

    // ======= Utils =======
    const badgeClass = (est) =>
        est === "APROBADO" ? "bg-success" : est === "RECHAZADO" ? "bg-danger" : "bg-secondary";
    const fmt = (s) => (s ? s.replace("T", " ").substring(0, 19) : "-");
    const money = (n) => new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS" }).format(n || 0);

    // ======= Banner flotante arriba =======
    const showBanner = (type, msg) => {
        const container = document.getElementById("toastContainer");
        if (!container) return alert(msg);

        const wrapper = document.createElement("div");
        wrapper.className = `alert alert-${type === "ok" ? "success" : "danger"} shadow fw-semibold border-0 fade show`;
        wrapper.style.opacity = "0";
        wrapper.style.transition = "opacity .25s ease";
        wrapper.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <span>${msg}</span>
            <button type="button" class="btn-close ms-2" aria-label="Close"></button>
        </div>
    `;

        container.appendChild(wrapper);

        setTimeout(() => { wrapper.style.opacity = "1"; }, 20);

        wrapper.querySelector(".btn-close").onclick = () => {
            wrapper.style.opacity = "0";
            setTimeout(() => wrapper.remove(), 250);
        };

        setTimeout(() => {
            if (wrapper.parentNode) {
                wrapper.style.opacity = "0";
                setTimeout(() => wrapper.remove(), 250);
            }
        }, 4000);
    };

    // ======= Servicios por tipo de pieza (solo UI) =======
    const MOTOR_SERVICES = [
        "Rectificaci√≥n de cilindros","Bru√±ido de cilindros","Planeado de block","Cambio de camisas",
        "Rectificaci√≥n de cig√ºe√±al","Pulido de cig√ºe√±al","Rectificaci√≥n de bielas",
        "Limpieza de block y piezas","Armado de motor completo",
    ];
    const TAPA_SERVICES = [
        "Planeado de tapa","Rectificaci√≥n de asientos de v√°lvulas","Cambio de gu√≠as de v√°lvula",
        "Cambio de retenes","Prueba hidr√°ulica de tapa","Ajuste de resortes y balancines",
        "Limpieza y arenado de tapa",
    ];

    // ======= Estado UI =======
    let selectedServices = new Set();
    window.extras = [];
    let solicitudActual = null;   // cache de la solicitud cargada

    function ensureExtrasContainer() {
        let c = document.getElementById("extrasChips");
        if (!c) {
            const grid = document.getElementById("serviciosGrid");
            const wrap = document.createElement("div");
            wrap.id = "extrasChips";
            wrap.className = "row g-2 mt-2";
            grid.parentElement.appendChild(wrap);
        }
    }

    function renderExtrasChips() {
        ensureExtrasContainer();
        const cont = document.getElementById("extrasChips");
        cont.innerHTML = "";
        if (!window.extras.length) return;
        window.extras.forEach((ex, i) => {
            cont.insertAdjacentHTML(
                "beforeend",
                `<div class="col-md-4" data-extra-idx="${i}">
           <div class="d-flex align-items-stretch">
             <button type="button" class="btn w-100 btn-primary" data-chip="extra">
               ${ex.nombre} (${money(ex.precio)})
             </button>
             <button type="button" class="btn btn-outline-danger ms-1" data-chip="extra-remove">&times;</button>
           </div>
         </div>`
            );
        });
    }

    function renderServiciosGrid(pieza) {
        const grid = document.getElementById("serviciosGrid");
        grid.innerHTML = "";
        const base = pieza === "TAPA" ? TAPA_SERVICES : MOTOR_SERVICES;
        base.forEach((nombre) => {
            const isSel = selectedServices.has(nombre);
            grid.insertAdjacentHTML(
                "beforeend",
                `<div class="col-md-4">
           <button type="button"
                   class="btn w-100 ${isSel ? "btn-primary" : "btn-outline-primary"}"
                   data-chip="servicio"
                   data-nombre="${nombre}">
             ${nombre}
           </button>
         </div>`
            );
        });
        renderExtrasChips();
    }

    function toggleChip(btn) {
        const nombre = btn.dataset.nombre;
        if (selectedServices.has(nombre)) {
            selectedServices.delete(nombre);
            btn.classList.remove("btn-primary");
            btn.classList.add("btn-outline-primary");
        } else {
            selectedServices.add(nombre);
            btn.classList.remove("btn-outline-primary");
            btn.classList.add("btn-primary");
        }
    }

    function initServiciosForCurrentPieza() {
        const pieza = document.querySelector('input[name="piezaTipo"]:checked')?.value || "MOTOR";
        const otros = Array.from(selectedServices).filter(
            (s) => !MOTOR_SERVICES.includes(s) && !TAPA_SERVICES.includes(s)
        );
        selectedServices = new Set(otros);
        renderServiciosGrid(pieza);
    }

    async function cargarPiezaDesdeSolicitud(sid) {
        const infoEl = document.getElementById("solicitudInfo");
        if (infoEl) {
            infoEl.textContent = "";
            infoEl.classList.remove("text-danger");
        }
        solicitudActual = null;

        if (!sid) return;
        try {
            const r = await fetch(`/public/presupuestos/solicitud/${encodeURIComponent(sid)}`);
            const j = await r.json().catch(() => ({}));
            if (!r.ok) throw new Error(j.message || `Solicitud ${sid} no encontrada`);

            solicitudActual = j;

            const pieza = (j.tipoUnidad || "").toUpperCase();
            const motor = document.getElementById("piezaMotor");
            const tapa  = document.getElementById("piezaTapa");

            if (pieza === "TAPA") {
                tapa.checked = true;
                motor.disabled = true;
                tapa.disabled = false;
            } else {
                motor.checked = true;
                motor.disabled = false;
                tapa.disabled = true;
            }
            initServiciosForCurrentPieza();

            if (infoEl) {
                const marca  = (j.marca  || "").trim();
                const modelo = (j.modelo || "").trim();
                if (!marca && !modelo) {
                    infoEl.textContent = `Solicitud #${j.id} ¬∑ sin marca / modelo (recomendado completarlo antes de generar)`;
                    infoEl.classList.add("text-danger");
                } else {
                    infoEl.textContent = `Solicitud #${j.id} ¬∑ ${[j.tipoUnidad, marca, modelo].filter(Boolean).join(" ")}`;
                    infoEl.classList.remove("text-danger");
                }
            }
        } catch (e) {
            console.warn("No se pudo leer la solicitud:", e.message || e);
            if (infoEl) {
                infoEl.textContent = "No se encontr√≥ la solicitud.";
                infoEl.classList.add("text-danger");
            }
        }
    }

    // ======= Tabla =======
    async function cargar() {
        if (!isAuthenticated()) {
            alert("Inici√° sesi√≥n admin.");
            location.href = "/login.html";
            return;
        }
        const estado = document.getElementById("fEstado").value;
        const sid = document.getElementById("fSolicitud").value.trim();
        const qs = new URLSearchParams();
        if (estado) qs.set("estado", estado);
        if (sid) qs.set("solicitudId", sid);

        const url = "/admin/presupuestos" + (qs.toString() ? "?" + qs.toString() : "");
        const r = await fetch(url, { headers: { ...getAuthHeader() } });
        const list = await r.json();

        const tb = document.getElementById("tbody");
        tb.innerHTML = "";

        list.forEach((p) => {
            let acciones = "-";

            if (p.estado === "PENDIENTE") {
                acciones =
                    `<div class="acciones-stack">
           <div class="acciones-line">
             <span class="badge text-bg-warning">Pendiente</span>
           </div>
           <div class="acciones-line">
             <button type="button"
                     class="btn btn-outline-success btn-sm btn-icon-circle"
                     data-act="aprobar" data-id="${p.id}"
                     title="Aprobar presupuesto">
               <i class="bi bi-check2"></i>
             </button>
             <button type="button"
                     class="btn btn-outline-danger btn-sm btn-icon-circle"
                     data-act="rechazar" data-id="${p.id}"
                     title="Rechazar presupuesto">
               <i class="bi bi-x-lg"></i>
             </button>
           </div>
         </div>`;
            } else if (p.estado === "APROBADO") {
                const senaOK = (p.senaEstado || "").toUpperCase() === "ACREDITADA";
                const finalOK = (p.finalEstado || "").toUpperCase() === "ACREDITADA";

                // üîß Bot√≥n Repuestos (solo si hay OT Y NO est√° el pago final acreditado)
                const btnRepuestos = (!finalOK && p.otNroOrden)
                    ? `<button type="button"
               class="btn btn-outline-dark btn-sm ms-2"
               data-act="repuestos"
               data-ot-nro="${p.otNroOrden}">
           <i class="bi bi-tools"></i> Repuestos
       </button>`
                    : "";

                if (finalOK) {
                    const tieneFactura = !!p.facturaNumero;

                    const btnRepuestosIcon = (!p.otNroOrden) ? "" : `
        <button type="button"
                class="btn btn-outline-dark btn-sm btn-icon-circle"
                data-act="repuestos"
                data-ot-nro="${p.otNroOrden}"
                title="Ver repuestos de la OT">
          <i class="bi bi-tools"></i>
        </button>`;

                    if (tieneFactura) {
                        acciones =
                            `<div class="acciones-stack">
             <div class="acciones-line">
               <span class="badge bg-success">Monto total pagado</span>
               ${p.facturaNumero ? `<span class="text-muted small ms-1">${p.facturaNumero}</span>` : ""}
               ${p.otNroOrden ? `<span class="badge text-bg-warning ms-1">OT: ${p.otNroOrden}</span>` : ""}
             </div>
             <div class="acciones-line">
               <button type="button"
                       class="btn btn-success btn-sm btn-icon-circle"
                       data-act="descargar-factura"
                       data-id="${p.id}"
                       data-tipo="${p.facturaTipo || "B"}"
                       title="Descargar factura ${p.facturaTipo || "B"}">
                 <i class="bi bi-download"></i>
               </button>
               <a class="btn btn-outline-primary btn-sm btn-icon-circle"
                  href="/estado-solicitud.html?id=${p.solicitudId ?? ""}"
                  target="_blank"
                  title="Ver p√°gina del cliente">
                 <i class="bi bi-box-arrow-up-right"></i>
               </a>
               ${btnRepuestosIcon}
             </div>
           </div>`;
                    } else {
                        acciones =
                            `<div class="acciones-stack">
             <div class="acciones-line">
               <span class="badge bg-success">Monto total pagado</span>
               ${p.otNroOrden ? `<span class="badge text-bg-warning ms-1">OT: ${p.otNroOrden}</span>` : ""}
             </div>
             <div class="acciones-line">
               <button type="button"
                       class="btn btn-outline-success btn-sm btn-icon-circle"
                       data-act="facturar" data-id="${p.id}"
                       title="Generar factura (A/B/C)">
                 <i class="bi bi-receipt"></i>
               </button>
               <a class="btn btn-outline-primary btn-sm btn-icon-circle"
                  href="/estado-solicitud.html?id=${p.solicitudId ?? ""}"
                  target="_blank"
                  title="Ver p√°gina del cliente">
                 <i class="bi bi-box-arrow-up-right"></i>
               </a>
               ${btnRepuestosIcon}
             </div>
           </div>`;
                    }
                } else {
                    const senaOK2 = (p.senaEstado || "").toUpperCase() === "ACREDITADA";

                    const chip = senaOK2
                        ? `<span class="badge bg-success">Se√±a acreditada</span>`
                        : `<span class="badge bg-warning text-dark">Se√±a pendiente</span>`;

                    const puedeCrearOT = (senaOK2 || finalOK) && !p.otNroOrden;

                    const btnRepuestosIcon = (!p.otNroOrden) ? "" : `
        <button type="button"
                class="btn btn-outline-dark btn-sm btn-icon-circle"
                data-act="repuestos"
                data-ot-nro="${p.otNroOrden}"
                title="Ver repuestos de la OT">
          <i class="bi bi-tools"></i>
        </button>`;

                    const btnCrearOT = `
        <button type="button"
                class="btn btn-warning btn-sm btn-icon-circle"
                data-act="crear-ot" data-id="${p.id}"
                ${puedeCrearOT ? "" : 'disabled title="Requiere se√±a acreditada o ya existe OT"'}
                title="${puedeCrearOT ? "Crear Orden de Trabajo" : "Requiere se√±a acreditada o ya existe OT"}">
          <i class="bi bi-plus-square"></i>
        </button>`;

                    acciones =
                        `<div class="acciones-stack">
         <div class="acciones-line">
           ${chip}
           ${p.otNroOrden ? `<span class="badge text-bg-warning ms-1">OT: ${p.otNroOrden}</span>` : ""}
         </div>
         <div class="acciones-line">
           <button type="button"
                   class="btn btn-outline-primary btn-sm btn-icon-circle"
                   data-act="pago-manual"
                   data-id="${p.id}"
                   data-total="${p.total ?? 0}"
                   data-sena-monto="${p.senaMonto ?? ""}"
                   data-sena-estado="${p.senaEstado ?? ""}"
                   data-final-estado="${p.finalEstado ?? ""}"
                   data-ot-nro="${p.otNroOrden ?? ""}"
                   title="Registrar pago manual">
             <i class="bi bi-cash-coin"></i>
           </button>

           <a class="btn btn-outline-primary btn-sm btn-icon-circle"
              href="/estado-solicitud.html?id=${p.solicitudId ?? ""}"
              target="_blank"
              title="Ver p√°gina del cliente">
             <i class="bi bi-box-arrow-up-right"></i>
           </a>

           ${btnRepuestosIcon}
           ${btnCrearOT}
         </div>
       </div>`;
                }
            }

            const solicitudTxt = p.solicitudId != null ? p.solicitudId : "-";
            tb.insertAdjacentHTML(
                "beforeend",
                `<tr data-row-id="${p.id}">
           <td>${p.id}</td>
           <td>${solicitudTxt}</td>
           <td>${p.clienteNombre}</td>
           <td>${p.vehiculoTipo}</td>
           <td>${money(p.total)}</td>
           <td><span class="badge ${badgeClass(p.estado)}">${p.estado}</span></td>
           <td>${fmt(p.creadaEn)}</td>
           <td>${acciones}</td>
         </tr>`
            );
        });
    }

    document.getElementById("btnBuscar").addEventListener("click", cargar);

    // ======= Acciones (tabla) =======
    document.getElementById("tbody").addEventListener("click", async (e) => {
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;
        const id = btn.dataset.id;
        const act = btn.dataset.act;

        // Aprobar / Rechazar
        if (act === "aprobar" || act === "rechazar") {
            const nota = prompt(act.toUpperCase() + ": nota/observaci√≥n (opcional)") ?? null;
            if (nota === null) return;
            btn.disabled = true;
            const r = await fetch(`/admin/presupuestos/${id}/${act}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json", ...getAuthHeader() },
                body: JSON.stringify({ nota }),
            });
            btn.disabled = false;
            const j = await r.json().catch(() => ({}));
            if (!r.ok) {
                showBanner("err", j.message || `Error HTTP ${r.status}`);
                return;
            }
            showBanner("ok", "Presupuesto " + act + " correctamente.");
            await cargar();
            return;
        }

        // Abrir pantalla de repuestos de la OT
        if (act === "repuestos") {
            const nroOt = btn.dataset.otNro;
            if (!nroOt) {
                showBanner("err", "No se encontr√≥ el n√∫mero de OT.");
                return;
            }
            location.href = `/admin-orden-repuestos.html?nro=${encodeURIComponent(nroOt)}`;
            return;
        }

        // Generar factura
        if (act === "facturar") {
            let tipo = prompt("Tipo de factura (A, B o C):", "B");
            if (!tipo) return;
            tipo = tipo.trim().toUpperCase();
            if (!["A", "B", "C"].includes(tipo)) {
                return alert("Tipo inv√°lido. Us√° A, B o C.");
            }

            try {
                btn.disabled = true;
                const r = await fetch(ENDPOINT_FACTURAR(id), {
                    method: "POST",
                    headers: { "Content-Type": "application/json", ...getAuthHeader() },
                    body: JSON.stringify({ tipo }),
                });
                const text = await r.text();
                let j; try { j = JSON.parse(text); } catch { j = { message: text }; }
                if (!r.ok) {
                    showBanner("err", "No se pudo generar la factura: " + (j.message || `HTTP ${r.status}`));
                    btn.disabled = false;
                    return;
                }
                showBanner("ok", "Factura generada: " + (j.numero || "OK"));
                await cargar();
            } catch (err) {
                btn.disabled = false;
                showBanner("err", "Error de red: " + (err?.message || err));
            }
            return;
        }

        // Descargar factura
        if (act === "descargar-factura") {
            const tipo = (btn.dataset.tipo || "B").toUpperCase();
            const url = ENDPOINT_PDF_BY_PRES(id, tipo);
            try {
                btn.disabled = true;
                const r = await fetch(url, { headers: { ...getAuthHeader() } });
                if (!r.ok) {
                    const txt = await r.text();
                    showBanner("err", "No se pudo descargar la factura: " + (txt || `HTTP ${r.status}`));
                    btn.disabled = false;
                    return;
                }
                const blob = await r.blob();
                const href = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = href;
                a.download = `factura-presupuesto-${id}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(href);
                btn.disabled = false;
            } catch (err) {
                btn.disabled = false;
                showBanner("err", "Error de red al descargar: " + (err?.message || err));
            }
            return;
        }

        // Pago manual
        if (act === "pago-manual") {
            const totalServicios = Number(btn.dataset.total || 0);      // s√≥lo servicios
            const senaMontoDato = btn.dataset.senaMonto;
            const senaEstado = (btn.dataset.senaEstado || "").toUpperCase();
            const finalEstado = (btn.dataset.finalEstado || "").toUpperCase();
            const senaMonto = senaMontoDato === "" ? null : Number(senaMontoDato);
            const otNro = btn.dataset.otNro || "";                      // ‚¨ÖÔ∏è nro de OT (si existe)

            if (finalEstado === "ACREDITADA") {
                showBanner("err", "Ya existe un pago FINAL acreditado para este presupuesto.");
                return;
            }

            // 1) Determinar tipo de pago (SENA / FINAL)
            const tipoDefault = senaEstado === "ACREDITADA" ? "FINAL" : "SENA";
            const tipo = prompt("Tipo de pago manual (SENA o FINAL):", tipoDefault);
            if (!tipo) return;
            const T = tipo.trim().toUpperCase();
            if (!["SENA", "FINAL"].includes(T)) {
                showBanner("err", "Tipo inv√°lido. Us√° SENA o FINAL.");
                return;
            }

            // 2) Calcular montos sugeridos (s√≥lo servicios para se√±a, servicios+repuestos para FINAL)
            const round2 = (n) => Math.round((Number(n) + Number.EPSILON) * 100) / 100;

            let totalConRepuestos = totalServicios;

            // Si hay OT, intentamos traer el total de repuestos
            if (otNro) {
                try {
                    const rTot = await fetch(`/admin/ordenes/${encodeURIComponent(otNro)}/repuestos/total`, {
                        headers: { ...getAuthHeader() }
                    });
                    if (rTot.ok) {
                        const jt = await rTot.json();
                        const totalRepuestos = Number(jt.totalRepuestos || 0);
                        totalConRepuestos = totalServicios + totalRepuestos;
                    }
                } catch (e) {
                    console.warn("No se pudo obtener total de repuestos para", otNro, e);
                }
            }

            // Se√±a esperada siempre sobre SERVICIOS
            const senaEsperada = round2(totalServicios * 0.30);

            // Final esperado = servicios + repuestos - se√±a (si ya se pag√≥)
            const finalEsperado = round2(
                totalConRepuestos - (senaMonto != null ? senaMonto : senaEsperada)
            );

            if (T === "FINAL" && senaEstado !== "ACREDITADA") {
                showBanner("err", "Para registrar pago FINAL primero debe estar acreditada la se√±a.");
                return;
            }

            // 3) Resto del flujo igual que antes (referencia, fecha, medio, etc.)
            let referencia = null;
            while (true) {
                const r = prompt("Referencia (OBLIGATORIA ‚Äî ej: recibo/transferencia):");
                if (r === null) return;
                if (r.trim().length > 0) { referencia = r.trim(); break; }
                alert("La referencia es obligatoria.");
            }

            const hoy = new Date().toISOString().slice(0, 10);
            const montoSugerido = T === "SENA" ? senaEsperada : finalEsperado;
            const fechaStr = prompt("Fecha (opcional, formato YYYY-MM-DD). Dejar vac√≠o = hoy", hoy) ?? null;
            const nota = prompt("Nota (opcional)") ?? null;
            const montoStr = prompt(`Monto ${T} exacto (ARS)`, montoSugerido.toFixed(2));
            if (montoStr === null) return;
            const medio = prompt("Medio (EFECTIVO/TRANSFERENCIA/TARJETA/OTRO):", "EFECTIVO");
            if (medio === null) return;
            const monto = Number(String(montoStr).replace(",", "."));
            if (!(monto > 0)) {
                showBanner("err", "Monto inv√°lido. Debe ser mayor a 0.");
                return;
            }
            let fechaPago = null;
            if (fechaStr && /^\d{4}-\d{2}-\d{2}$/.test(fechaStr)) fechaPago = fechaStr;
            else if (fechaStr && fechaStr.trim() !== "") {
                showBanner("err", "Fecha inv√°lida. Us√° formato YYYY-MM-DD.");
                return;
            }

            const payload = {
                presupuestoId: Number(id),
                tipo: T,
                medio: (medio || "").trim().toUpperCase(),
                referencia,
                monto,
                fechaPago: fechaPago || null,
                nota: (nota || "").trim(),
            };

            btn.disabled = true;
            try {
                const r = await fetch(ENDPOINT_PM, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", ...getAuthHeader() },
                    body: JSON.stringify(payload),
                });
                const text = await r.text();
                let j; try { j = JSON.parse(text); } catch { j = { message: text }; }
                if (!r.ok) {
                    btn.disabled = false;
                    const msg = j.message || `HTTP ${r.status}`;
                    showBanner("err", "Error al registrar pago manual: " + msg);
                    return;
                }
                showBanner("ok", `Pago ${T} manual registrado correctamente.`);
                await cargar();
            } catch (err) {
                btn.disabled = false;
                showBanner("err", "Error de red al registrar pago manual: " + (err?.message || err));
            }
            return;
        }

        // ===== NUEVO: Crear OT =====
        if (act === "crear-ot") {
            if (btn.dataset.busy === "1") return;
            if (!confirm("¬øCrear Orden de Trabajo para este presupuesto?")) return;

            btn.dataset.busy = "1";
            btn.disabled = true;

            const replaceBtnWithBadge = (nro) => {
                const badge = document.createElement("span");
                badge.className = "badge text-bg-warning";
                badge.textContent = `OT: ${nro}`;
                btn.replaceWith(badge);
            };

            try {
                const r = await fetch(`/admin/ordenes/by-presupuesto/${id}`, {
                    method: "POST",
                    headers: { ...getAuthHeader() }
                });

                const text = await r.text();
                let j; try { j = JSON.parse(text); } catch { j = {}; }

                if (r.status === 409) {
                    const nro = j?.nroOrden || j?.otNroOrden;
                    if (nro) replaceBtnWithBadge(nro);
                    else await cargar();
                    showBanner("err", j?.message || "Este presupuesto ya tiene una OT asociada o falta se√±a.");
                    return;
                }

                if (!r.ok) {
                    showBanner("err", j?.message || `No se pudo crear la OT (HTTP ${r.status})`);
                    btn.dataset.busy = "0";
                    btn.disabled = false;
                    return;
                }

                const nro = j?.nroOrden;
                if (nro) {
                    replaceBtnWithBadge(nro);
                    showBanner("ok", `OT creada correctamente. N√∫mero: ${nro}`);
                } else {
                    showBanner("ok", "OT creada correctamente.");
                }

                // üîÅ recarga la tabla para que aparezca el bot√≥n Repuestos
                await cargar();
            } catch (e) {
                showBanner("err", "Error de red: " + (e?.message || e));
                btn.dataset.busy = "0";
                btn.disabled = false;
            }
            return;
        }
    });

    // ======= Generar presupuesto (con extras) =======
    document.getElementById("gen").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const solicitudId = Number(fd.get("solicitudId"));
        const vehiculoTipo = fd.get("vehiculoTipo");
        const piezaTipo = fd.get("piezaTipo") || "MOTOR";
        const servicios = Array.from(selectedServices);
        const genErr = document.getElementById("genErr");

        const showError = (msg) => {
            genErr.classList.remove("d-none");
            genErr.textContent = msg;
        };

        genErr.classList.add("d-none");

        if (!solicitudId || Number.isNaN(solicitudId) || solicitudId <= 0) {
            return showError("Ingres√° un Solicitud ID v√°lido.");
        }

        if (!solicitudActual || Number(solicitudActual.id) !== solicitudId) {
            await cargarPiezaDesdeSolicitud(String(solicitudId));
        }

        if (!solicitudActual) {
            return showError("No se pudo leer la solicitud. Verific√° el ID.");
        }
        const marca  = (solicitudActual.marca  || "").trim();
        const modelo = (solicitudActual.modelo || "").trim();
        if (!marca && !modelo) {
            return showError("La solicitud no tiene marca / modelo cargados. Completalos antes de generar el presupuesto.");
        }

        const vehiculosValidos = ["CONVENCIONAL", "IMPORTADO"];
        if (!vehiculosValidos.includes(vehiculoTipo)) {
            return showError("Seleccion√° un tipo de veh√≠culo v√°lido.");
        }

        const piezasValidas = ["MOTOR", "TAPA"];
        if (!piezasValidas.includes(piezaTipo)) {
            return showError("Seleccion√° una pieza v√°lida (Motor o Tapa).");
        }

        const extras = Array.isArray(window.extras) ? window.extras.slice() : [];

        if (servicios.length === 0 && extras.length === 0) {
            return showError("Seleccion√° al menos un servicio o agreg√° un √≠tem extra.");
        }

        for (const ex of extras) {
            const nombre = (ex.nombre || "").trim();
            const precio = Number(ex.precio);
            if (!nombre) {
                return showError("Hay un servicio extra sin nombre. Corregilo antes de generar.");
            }
            if (!(precio > 0)) {
                return showError("Hay un servicio extra con precio inv√°lido (debe ser mayor a 0).");
            }
        }

        const payload = { solicitudId, vehiculoTipo, piezaTipo, servicios, extras };

        try {
            const r = await fetch("/presupuestos/generar", {
                method: "POST",
                headers: { "Content-Type": "application/json", ...getAuthHeader() },
                body: JSON.stringify(payload),
            });
            const j = await r.json().catch(() => ({}));
            if (!r.ok) throw new Error(j.message || "No se pudo generar");

            const ok = document.getElementById("genOk");
            ok.classList.remove("d-none");
            ok.textContent = "Generado presupuesto #" + j.id + " por " + money(j.total) + ".";
            genErr.classList.add("d-none");

            selectedServices.clear();
            window.extras = [];
            initServiciosForCurrentPieza();
            cargar();
        } catch (err) {
            showError(err.message);
        }
    });

    // ======= Interacciones UI =======
    document.addEventListener("click", (e) => {
        const chip = e.target.closest('button[data-chip="servicio"]');
        if (chip) return toggleChip(chip);

        const rm = e.target.closest('button[data-chip="extra-remove"]');
        if (rm) {
            const col = rm.closest('[data-extra-idx]');
            const idx = Number(col?.dataset?.extraIdx);
            if (!Number.isNaN(idx)) {
                window.extras.splice(idx, 1);
                renderExtrasChips();
            }
            return;
        }

        const extra = e.target.closest('button[data-chip="extra"]');
        if (extra) {
            const col = extra.closest('[data-extra-idx]');
            const idx = Number(col?.dataset?.extraIdx);
            if (!Number.isNaN(idx)) {
                window.extras.splice(idx, 1);
                renderExtrasChips();
            }
        }
    });

    document.getElementById("piezaMotor").addEventListener("change", initServiciosForCurrentPieza);
    document.getElementById("piezaTapa").addEventListener("change", initServiciosForCurrentPieza);

    document.getElementById("btnSrvOtro").addEventListener("click", () => {
        const nombre = (document.getElementById("srvOtro").value || "").trim();
        const precio = Number(document.getElementById("srvOtroPrecio").value);
        if (!nombre) return alert("Ingres√° un nombre de servicio.");
        if (!(precio > 0)) return alert("Ingres√° un precio v√°lido.");
        window.extras.push({ nombre, precio });
        renderExtrasChips();
        document.getElementById("srvOtro").value = "";
        document.getElementById("srvOtroPrecio").value = "";
    });

    document.getElementById("srvOtro").addEventListener("keydown", (e) => {
        if (e.key === "Enter") { e.preventDefault(); document.getElementById("btnSrvOtro").click(); }
    });

    const inpSid = document.querySelector('input[name="solicitudId"]');
    if (inpSid) {
        const go = () => cargarPiezaDesdeSolicitud(inpSid.value.trim());
        inpSid.addEventListener("change", go);
        inpSid.addEventListener("blur", go);
    }

    async function initAutofillFromQuery() {
        const qp = new URLSearchParams(location.search);
        const sid = qp.get("sid");
        if (!sid) return;
        await cargarPiezaDesdeSolicitud(sid);
        if (inpSid) inpSid.value = sid;
    }

    await initAutofillFromQuery();
    initServiciosForCurrentPieza();
    window.addEventListener("DOMContentLoaded", cargar);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>