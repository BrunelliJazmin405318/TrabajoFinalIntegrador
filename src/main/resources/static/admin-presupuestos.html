<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin | Presupuestos (Checkout API)</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<!-- üü¶ BANNER FLOATING TOP (NUEVO) -->
<div id="toastContainer"
     class="position-fixed top-0 start-50 translate-middle-x p-3"
     style="z-index:3000; width:100%; max-width:430px;">
</div>
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="/presupuesto.html"><i class="bi bi-gear-fill me-2"></i>Rectificadora</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
        <div id="nav" class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/admin-solicitudes.html">Solicitudes</a></li>
                <li class="nav-item"><a class="nav-link active" href="/admin-presupuestos.html">Presupuestos</a></li>
            </ul>
        </div>
    </div>
</nav>

<main class="container page-wrap">
    <div class="page-title d-flex align-items-center gap-2 my-3">
        <h1 class="m-0">Presupuestos</h1>
        <span class="badge">Panel Admin</span>
        <span class="badge text-bg-info">Checkout API</span>
    </div>

    <!-- Generaci√≥n r√°pida (NUEVO) -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Generar desde solicitud aprobada</h5>

            <form id="gen" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">Solicitud ID</label>
                    <input class="form-control" name="solicitudId" required>
                    <div id="solicitudInfo" class="form-text text-muted"></div>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Tipo veh√≠culo</label>
                    <select class="form-select" name="vehiculoTipo" required>
                        <option value="CONVENCIONAL">Convencional</option>
                        <option value="IMPORTADO">Importado</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Pieza</label>
                    <div class="btn-group d-flex" role="group" aria-label="piezaTipo">
                        <input type="radio" class="btn-check" name="piezaTipo" id="piezaMotor" value="MOTOR" autocomplete="off" checked data-lockable>
                        <label class="btn btn-outline-primary" for="piezaMotor">Motor</label>

                        <input type="radio" class="btn-check" name="piezaTipo" id="piezaTapa" value="TAPA" autocomplete="off" data-lockable="">
                        <label class="btn btn-outline-primary" for="piezaTapa">Tapa</label>
                    </div>
                </div>

                <div class="col-12">
                    <label class="form-label d-block">Servicios</label>

                    <!-- GRILLA de chips -->
                    <div id="serviciosGrid" class="row g-2"></div>

                    <!-- Agregar otro -->
                    <div class="input-group mt-3" style="max-width: 560px;">
                        <input id="srvOtro" type="text" class="form-control" placeholder="Agregar otro servicio‚Ä¶">
                        <input id="srvOtroPrecio" type="number" class="form-control" placeholder="Precio ($)" min="0" step="0.01" style="max-width: 150px;">
                        <button id="btnSrvOtro" class="btn btn-outline-secondary" type="button">
                            <i class="bi bi-plus-lg"></i> Agregar
                        </button>
                    </div>
                    <div class="form-text">Hac√© click para seleccionar/deseleccionar. Pod√©s agregar servicios personalizados con su precio.</div>
                </div>

                <div class="col-md-3 d-grid">
                    <button class="btn btn-primary" type="submit">Generar</button>
                </div>
            </form>

            <div id="genOk"  class="alert alert-success mt-2 d-none"></div>
            <div id="genErr" class="alert alert-danger  mt-2 d-none"></div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row g-2 mb-3">
        <div class="col-md-3">
            <select id="fEstado" class="form-select">
                <option value="">Todos</option>
                <option value="PENDIENTE" selected>Pendientes</option>
                <option value="APROBADO">Aprobados</option>
                <option value="RECHAZADO">Rechazados</option>
            </select>
        </div>
        <div class="col-md-3">
            <input id="fSolicitud" class="form-control" placeholder="Filtrar por Solicitud ID">
        </div>
        <div class="col-md-2 d-grid">
            <button id="btnBuscar" class="btn btn-secondary">Buscar</button>
        </div>
    </div>

    <!-- Tabla -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered align-middle mb-0">
                    <thead>
                    <tr>
                        <th>ID</th><th>Solicitud</th><th>Cliente</th><th>Tipo</th><th>Total</th><th>Estado</th><th>Creada</th><th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<footer class="site-footer">
    <div class="container d-flex justify-content-between">
        <span>¬©Ô∏è Rectificadora ‚Äî demo acad√©mica</span>
        <span class="muted">Negro/Gris/Blanco + Rojo</span>
    </div>
</footer>

<script type="module">
    import { getAuthHeader, isAuthenticated } from "/js/auth.js";

    // ======= Config =======
    const ENDPOINT_PM = "/admin/pagos-manuales/registrar";
    const ENDPOINT_PDF_BY_PRES = (id, tipo = "B") =>
        `/admin/facturas/pdf/by-presupuesto/${id}?tipo=${encodeURIComponent(tipo)}`;
    const ENDPOINT_FACTURAR = (id) => `/admin/facturas/generar/${id}`;

    // ======= Utils =======
    const badgeClass = (est) =>
        est === "APROBADO" ? "bg-success" : est === "RECHAZADO" ? "bg-danger" : "bg-secondary";
    const fmt = (s) => (s ? s.replace("T", " ").substring(0, 19) : "-");
    const money = (n) => new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS" }).format(n || 0);

    // ======= Banner flotante arriba =======
    const showBanner = (type, msg) => {
        const container = document.getElementById("toastContainer");
        if (!container) return alert(msg);

        const wrapper = document.createElement("div");
        wrapper.className = `alert alert-${type === "ok" ? "success" : "danger"} shadow fw-semibold border-0 fade show`;
        wrapper.style.opacity = "0";
        wrapper.style.transition = "opacity .25s ease";
        wrapper.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <span>${msg}</span>
            <button type="button" class="btn-close ms-2" aria-label="Close"></button>
        </div>
    `;

        container.appendChild(wrapper);

        setTimeout(() => { wrapper.style.opacity = "1"; }, 20);

        wrapper.querySelector(".btn-close").onclick = () => {
            wrapper.style.opacity = "0";
            setTimeout(() => wrapper.remove(), 250);
        };

        setTimeout(() => {
            if (wrapper.parentNode) {
                wrapper.style.opacity = "0";
                setTimeout(() => wrapper.remove(), 250);
            }
        }, 4000);
    };

    // ======= Servicios por tipo de pieza (solo UI) =======
    const MOTOR_SERVICES = [
        "Rectificaci√≥n de cilindros","Bru√±ido de cilindros","Planeado de block","Cambio de camisas",
        "Rectificaci√≥n de cig√ºe√±al","Pulido de cig√ºe√±al","Rectificaci√≥n de bielas",
        "Limpieza de block y piezas","Armado de motor completo",
    ];
    const TAPA_SERVICES = [
        "Planeado de tapa","Rectificaci√≥n de asientos de v√°lvulas","Cambio de gu√≠as de v√°lvula",
        "Cambio de retenes","Prueba hidr√°ulica de tapa","Ajuste de resortes y balancines",
        "Limpieza y arenado de tapa",
    ];

    // ======= Estado UI =======
    let selectedServices = new Set();
    window.extras = [];
    let solicitudActual = null;   // cache de la solicitud cargada

    function ensureExtrasContainer() {
        let c = document.getElementById("extrasChips");
        if (!c) {
            const grid = document.getElementById("serviciosGrid");
            const wrap = document.createElement("div");
            wrap.id = "extrasChips";
            wrap.className = "row g-2 mt-2";
            grid.parentElement.appendChild(wrap);
        }
    }

    function renderExtrasChips() {
        ensureExtrasContainer();
        const cont = document.getElementById("extrasChips");
        cont.innerHTML = "";
        if (!window.extras.length) return;
        window.extras.forEach((ex, i) => {
            cont.insertAdjacentHTML(
                "beforeend",
                `<div class="col-md-4" data-extra-idx="${i}">
           <div class="d-flex align-items-stretch">
             <button type="button" class="btn w-100 btn-primary" data-chip="extra">
               ${ex.nombre} (${money(ex.precio)})
             </button>
             <button type="button" class="btn btn-outline-danger ms-1" data-chip="extra-remove">&times;</button>
           </div>
         </div>`
            );
        });
    }

    function renderServiciosGrid(pieza) {
        const grid = document.getElementById("serviciosGrid");
        grid.innerHTML = "";
        const base = pieza === "TAPA" ? TAPA_SERVICES : MOTOR_SERVICES;
        base.forEach((nombre) => {
            const isSel = selectedServices.has(nombre);
            grid.insertAdjacentHTML(
                "beforeend",
                `<div class="col-md-4">
           <button type="button"
                   class="btn w-100 ${isSel ? "btn-primary" : "btn-outline-primary"}"
                   data-chip="servicio"
                   data-nombre="${nombre}">
             ${nombre}
           </button>
         </div>`
            );
        });
        renderExtrasChips();
    }

    function toggleChip(btn) {
        const nombre = btn.dataset.nombre;
        if (selectedServices.has(nombre)) {
            selectedServices.delete(nombre);
            btn.classList.remove("btn-primary");
            btn.classList.add("btn-outline-primary");
        } else {
            selectedServices.add(nombre);
            btn.classList.remove("btn-outline-primary");
            btn.classList.add("btn-primary");
        }
    }

    function initServiciosForCurrentPieza() {
        const pieza = document.querySelector('input[name="piezaTipo"]:checked')?.value || "MOTOR";
        const otros = Array.from(selectedServices).filter(
            (s) => !MOTOR_SERVICES.includes(s) && !TAPA_SERVICES.includes(s)
        );
        selectedServices = new Set(otros);
        renderServiciosGrid(pieza);
    }

    async function cargarPiezaDesdeSolicitud(sid) {
        const infoEl = document.getElementById("solicitudInfo");
        if (infoEl) {
            infoEl.textContent = "";
            infoEl.classList.remove("text-danger");
        }
        solicitudActual = null;

        if (!sid) return;
        try {
            const r = await fetch(`/public/presupuestos/solicitud/${encodeURIComponent(sid)}`);
            const j = await r.json().catch(() => ({}));
            if (!r.ok) throw new Error(j.message || `Solicitud ${sid} no encontrada`);

            solicitudActual = j;

            const pieza = (j.tipoUnidad || "").toUpperCase();
            const motor = document.getElementById("piezaMotor");
            const tapa  = document.getElementById("piezaTapa");

            if (pieza === "TAPA") {
                tapa.checked = true;
                motor.disabled = true;
                tapa.disabled = false;
            } else {
                motor.checked = true;
                motor.disabled = false;
                tapa.disabled = true;
            }
            initServiciosForCurrentPieza();

            if (infoEl) {
                const marca  = (j.marca  || "").trim();
                const modelo = (j.modelo || "").trim();
                if (!marca && !modelo) {
                    infoEl.textContent = `Solicitud #${j.id} ¬∑ sin marca / modelo (recomendado completarlo antes de generar)`;
                    infoEl.classList.add("text-danger");
                } else {
                    infoEl.textContent = `Solicitud #${j.id} ¬∑ ${[j.tipoUnidad, marca, modelo].filter(Boolean).join(" ")}`;
                    infoEl.classList.remove("text-danger");
                }
            }
        } catch (e) {
            console.warn("No se pudo leer la solicitud:", e.message || e);
            if (infoEl) {
                infoEl.textContent = "No se encontr√≥ la solicitud.";
                infoEl.classList.add("text-danger");
            }
        }
    }

    // ======= Tabla =======
    async function cargar() {
        if (!isAuthenticated()) {
            alert("Inici√° sesi√≥n admin.");
            location.href = "/login.html";
            return;
        }
        const estado = document.getElementById("fEstado").value;
        const sid = document.getElementById("fSolicitud").value.trim();
        const qs = new URLSearchParams();
        if (estado) qs.set("estado", estado);
        if (sid) qs.set("solicitudId", sid);

        const url = "/admin/presupuestos" + (qs.toString() ? "?" + qs.toString() : "");
        const r = await fetch(url, { headers: { ...getAuthHeader() } });
        const list = await r.json();

        const tb = document.getElementById("tbody");
        tb.innerHTML = "";

        list.forEach((p) => {
            let acciones = "-";

            if (p.estado === "PENDIENTE") {
                acciones =
                    `<button type="button" class="btn btn-success btn-sm me-1" data-act="aprobar" data-id="${p.id}">
             <i class="bi bi-check2"></i> Aprobar
           </button>
           <button type="button" class="btn btn-danger btn-sm" data-act="rechazar" data-id="${p.id}">
             <i class="bi bi-x-lg"></i> Rechazar
           </button>`;
            } else if (p.estado === "APROBADO") {
                const senaOK  = (p.senaEstado  || "").toUpperCase() === "ACREDITADA";
                const finalOK = (p.finalEstado || "").toUpperCase() === "ACREDITADA";

                // üîß Bot√≥n Repuestos (solo si hay OT Y NO est√° el pago final acreditado)
                const btnRepuestos = (!finalOK && p.otNroOrden)
                    ? `<button type="button"
               class="btn btn-outline-dark btn-sm ms-2"
               data-act="repuestos"
               data-ot-nro="${p.otNroOrden}">
           <i class="bi bi-tools"></i> Repuestos
       </button>`
                    : "";

                if (finalOK) {
                    const tieneFactura = !!p.facturaNumero;
                    if (tieneFactura) {
                        acciones =
                            `<span class="badge bg-success me-2">Monto total pagado</span>
               ${p.finalPaymentId ? `<span class="text-muted">#${p.finalPaymentId}</span>` : ""}
               <button type="button" class="btn btn-success btn-sm ms-2"
                       data-act="descargar-factura" data-id="${p.id}" data-tipo="${p.facturaTipo || "B"}">
                 <i class="bi bi-download"></i> Descargar factura ${p.facturaTipo || "B"}
               </button>
               <a class="btn btn-outline-primary btn-sm ms-2" target="_blank"
                  href="/estado-solicitud.html?id=${p.solicitudId ?? ""}">
                 <i class="bi bi-box-arrow-up-right"></i> P√°gina del cliente
               </a>
               <span class="text-muted ms-2">${p.facturaNumero}</span>
               ${btnRepuestos}`;
                    } else {
                        acciones =
                            `<span class="badge bg-success me-2">Monto total pagado</span>
               ${p.finalPaymentId ? `<span class="text-muted">#${p.finalPaymentId}</span>` : ""}
               <button type="button" class="btn btn-outline-success btn-sm ms-2"
                       data-act="facturar" data-id="${p.id}">
                 <i class="bi bi-receipt"></i> Generar factura (A/B/C)
               </button>
               <a class="btn btn-outline-primary btn-sm ms-2" target="_blank"
                  href="/estado-solicitud.html?id=${p.solicitudId ?? ""}">
                 <i class="bi bi-box-arrow-up-right"></i> P√°gina del cliente
               </a>
               ${btnRepuestos}`;
                    }
                } else {
                    const senaOK2  = (p.senaEstado  || "").toUpperCase() === "ACREDITADA";
                    const chip = senaOK2
                        ? `<span class="badge bg-success me-2">Se√±a acreditada</span>${p.senaPaymentId ? `<span class="text-muted me-2">#${p.senaPaymentId}</span>` : ""}`
                        : `<span class="badge bg-warning text-dark me-2">Se√±a pendiente</span>`;

                    const otBadge = p.otNroOrden
                        ? `<div class="mt-2">
                             <span class="badge text-bg-warning me-2">OT: ${p.otNroOrden}</span>
                             ${btnRepuestos}
                           </div>`
                        : btnRepuestos;

                    const puedeCrearOT = (senaOK2 || finalOK) && !p.otNroOrden;
                    const btnCrearOT = puedeCrearOT
                        ? `<button type="button" class="btn btn-warning btn-sm mt-2"
                       data-act="crear-ot" data-id="${p.id}">
                 <i class="bi bi-plus-square"></i> Crear OT
               </button>`
                        : `<button type="button" class="btn btn-warning btn-sm mt-2" disabled
                   title="${p.otNroOrden ? 'Ya existe OT' : 'Requiere se√±a acreditada'}">
                 <i class="bi bi-plus-square"></i> Crear OT
               </button>`;

                    acciones =
                        `${chip}
             <a class="btn btn-outline-primary btn-sm me-2" target="_blank"
                href="/estado-solicitud.html?id=${p.solicitudId ?? ""}">
               <i class="bi bi-box-arrow-up-right"></i> P√°gina del cliente
             </a>
             <button type="button" class="btn btn-outline-primary btn-sm"
                data-act="pago-manual"
                data-id="${p.id}"
                data-total="${p.total ?? 0}"
                data-sena-monto="${p.senaMonto ?? ""}"
                data-sena-estado="${p.senaEstado ?? ""}"
                data-final-estado="${p.finalEstado ?? ""}"
                data-ot-nro="${p.otNroOrden ?? ""}">
            <i class="bi bi-cash-coin"></i> Registrar pago manual
        </button>
             ${otBadge}
             ${btnCrearOT}`;
                }
            }

            const solicitudTxt = p.solicitudId != null ? p.solicitudId : "-";
            tb.insertAdjacentHTML(
                "beforeend",
                `<tr data-row-id="${p.id}">
           <td>${p.id}</td>
           <td>${solicitudTxt}</td>
           <td>${p.clienteNombre}</td>
           <td>${p.vehiculoTipo}</td>
           <td>${money(p.total)}</td>
           <td><span class="badge ${badgeClass(p.estado)}">${p.estado}</span></td>
           <td>${fmt(p.creadaEn)}</td>
           <td>${acciones}</td>
         </tr>`
            );
        });
    }

    document.getElementById("btnBuscar").addEventListener("click", cargar);

    // ======= Acciones (tabla) =======
    document.getElementById("tbody").addEventListener("click", async (e) => {
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;
        const id = btn.dataset.id;
        const act = btn.dataset.act;

        // Aprobar / Rechazar
        if (act === "aprobar" || act === "rechazar") {
            const nota = prompt(act.toUpperCase() + ": nota/observaci√≥n (opcional)") ?? null;
            if (nota === null) return;
            btn.disabled = true;
            const r = await fetch(`/admin/presupuestos/${id}/${act}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json", ...getAuthHeader() },
                body: JSON.stringify({ nota }),
            });
            btn.disabled = false;
            const j = await r.json().catch(() => ({}));
            if (!r.ok) {
                showBanner("err", j.message || `Error HTTP ${r.status}`);
                return;
            }
            showBanner("ok", "Presupuesto " + act + " correctamente.");
            await cargar();
            return;
        }

        // Abrir pantalla de repuestos de la OT
        if (act === "repuestos") {
            const nroOt = btn.dataset.otNro;
            if (!nroOt) {
                showBanner("err", "No se encontr√≥ el n√∫mero de OT.");
                return;
            }
            location.href = `/admin-orden-repuestos.html?nro=${encodeURIComponent(nroOt)}`;
            return;
        }

        // Generar factura
        if (act === "facturar") {
            let tipo = prompt("Tipo de factura (A, B o C):", "B");
            if (!tipo) return;
            tipo = tipo.trim().toUpperCase();
            if (!["A", "B", "C"].includes(tipo)) {
                return alert("Tipo inv√°lido. Us√° A, B o C.");
            }

            try {
                btn.disabled = true;
                const r = await fetch(ENDPOINT_FACTURAR(id), {
                    method: "POST",
                    headers: { "Content-Type": "application/json", ...getAuthHeader() },
                    body: JSON.stringify({ tipo }),
                });
                const text = await r.text();
                let j; try { j = JSON.parse(text); } catch { j = { message: text }; }
                if (!r.ok) {
                    showBanner("err", "No se pudo generar la factura: " + (j.message || `HTTP ${r.status}`));
                    btn.disabled = false;
                    return;
                }
                showBanner("ok", "Factura generada: " + (j.numero || "OK"));
                await cargar();
            } catch (err) {
                btn.disabled = false;
                showBanner("err", "Error de red: " + (err?.message || err));
            }
            return;
        }

        // Descargar factura
        if (act === "descargar-factura") {
            const tipo = (btn.dataset.tipo || "B").toUpperCase();
            const url = ENDPOINT_PDF_BY_PRES(id, tipo);
            try {
                btn.disabled = true;
                const r = await fetch(url, { headers: { ...getAuthHeader() } });
                if (!r.ok) {
                    const txt = await r.text();
                    showBanner("err", "No se pudo descargar la factura: " + (txt || `HTTP ${r.status}`));
                    btn.disabled = false;
                    return;
                }
                const blob = await r.blob();
                const href = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = href;
                a.download = `factura-presupuesto-${id}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(href);
                btn.disabled = false;
            } catch (err) {
                btn.disabled = false;
                showBanner("err", "Error de red al descargar: " + (err?.message || err));
            }
            return;
        }

        // Pago manual
        if (act === "pago-manual") {
            const totalServicios = Number(btn.dataset.total || 0);      // s√≥lo servicios
            const senaMontoDato = btn.dataset.senaMonto;
            const senaEstado = (btn.dataset.senaEstado || "").toUpperCase();
            const finalEstado = (btn.dataset.finalEstado || "").toUpperCase();
            const senaMonto = senaMontoDato === "" ? null : Number(senaMontoDato);
            const otNro = btn.dataset.otNro || "";                      // ‚¨ÖÔ∏è nro de OT (si existe)

            if (finalEstado === "ACREDITADA") {
                showBanner("err", "Ya existe un pago FINAL acreditado para este presupuesto.");
                return;
            }

            // 1) Determinar tipo de pago (SENA / FINAL)
            const tipoDefault = senaEstado === "ACREDITADA" ? "FINAL" : "SENA";
            const tipo = prompt("Tipo de pago manual (SENA o FINAL):", tipoDefault);
            if (!tipo) return;
            const T = tipo.trim().toUpperCase();
            if (!["SENA", "FINAL"].includes(T)) {
                showBanner("err", "Tipo inv√°lido. Us√° SENA o FINAL.");
                return;
            }

            // 2) Calcular montos sugeridos (s√≥lo servicios para se√±a, servicios+repuestos para FINAL)
            const round2 = (n) => Math.round((Number(n) + Number.EPSILON) * 100) / 100;

            let totalConRepuestos = totalServicios;

            // Si hay OT, intentamos traer el total de repuestos
            if (otNro) {
                try {
                    const rTot = await fetch(`/admin/ordenes/${encodeURIComponent(otNro)}/repuestos/total`, {
                        headers: { ...getAuthHeader() }
                    });
                    if (rTot.ok) {
                        const jt = await rTot.json();
                        const totalRepuestos = Number(jt.totalRepuestos || 0);
                        totalConRepuestos = totalServicios + totalRepuestos;
                    }
                } catch (e) {
                    console.warn("No se pudo obtener total de repuestos para", otNro, e);
                }
            }

            // Se√±a esperada siempre sobre SERVICIOS
            const senaEsperada = round2(totalServicios * 0.30);

            // Final esperado = servicios + repuestos - se√±a (si ya se pag√≥)
            const finalEsperado = round2(
                totalConRepuestos - (senaMonto != null ? senaMonto : senaEsperada)
            );

            if (T === "FINAL" && senaEstado !== "ACREDITADA") {
                showBanner("err", "Para registrar pago FINAL primero debe estar acreditada la se√±a.");
                return;
            }

            // 3) Resto del flujo igual que antes (referencia, fecha, medio, etc.)
            let referencia = null;
            while (true) {
                const r = prompt("Referencia (OBLIGATORIA ‚Äî ej: recibo/transferencia):");
                if (r === null) return;
                if (r.trim().length > 0) { referencia = r.trim(); break; }
                alert("La referencia es obligatoria.");
            }

            const hoy = new Date().toISOString().slice(0, 10);
            const montoSugerido = T === "SENA" ? senaEsperada : finalEsperado;
            const fechaStr = prompt("Fecha (opcional, formato YYYY-MM-DD). Dejar vac√≠o = hoy", hoy) ?? null;
            const nota = prompt("Nota (opcional)") ?? null;
            const montoStr = prompt(`Monto ${T} exacto (ARS)`, montoSugerido.toFixed(2));
            if (montoStr === null) return;
            const medio = prompt("Medio (EFECTIVO/TRANSFERENCIA/TARJETA/OTRO):", "EFECTIVO");
            if (medio === null) return;
            const monto = Number(String(montoStr).replace(",", "."));
            if (!(monto > 0)) {
                showBanner("err", "Monto inv√°lido. Debe ser mayor a 0.");
                return;
            }
            let fechaPago = null;
            if (fechaStr && /^\d{4}-\d{2}-\d{2}$/.test(fechaStr)) fechaPago = fechaStr;
            else if (fechaStr && fechaStr.trim() !== "") {
                showBanner("err", "Fecha inv√°lida. Us√° formato YYYY-MM-DD.");
                return;
            }

            const payload = {
                presupuestoId: Number(id),
                tipo: T,
                medio: (medio || "").trim().toUpperCase(),
                referencia,
                monto,
                fechaPago: fechaPago || null,
                nota: (nota || "").trim(),
            };

            btn.disabled = true;
            try {
                const r = await fetch(ENDPOINT_PM, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", ...getAuthHeader() },
                    body: JSON.stringify(payload),
                });
                const text = await r.text();
                let j; try { j = JSON.parse(text); } catch { j = { message: text }; }
                if (!r.ok) {
                    btn.disabled = false;
                    const msg = j.message || `HTTP ${r.status}`;
                    showBanner("err", "Error al registrar pago manual: " + msg);
                    return;
                }
                showBanner("ok", `Pago ${T} manual registrado correctamente.`);
                await cargar();
            } catch (err) {
                btn.disabled = false;
                showBanner("err", "Error de red al registrar pago manual: " + (err?.message || err));
            }
            return;
        }

        // ===== NUEVO: Crear OT =====
        if (act === "crear-ot") {
            if (btn.dataset.busy === "1") return;
            if (!confirm("¬øCrear Orden de Trabajo para este presupuesto?")) return;

            btn.dataset.busy = "1";
            btn.disabled = true;

            const replaceBtnWithBadge = (nro) => {
                const badge = document.createElement("span");
                badge.className = "badge text-bg-warning";
                badge.textContent = `OT: ${nro}`;
                btn.replaceWith(badge);
            };

            try {
                const r = await fetch(`/admin/ordenes/by-presupuesto/${id}`, {
                    method: "POST",
                    headers: { ...getAuthHeader() }
                });

                const text = await r.text();
                let j; try { j = JSON.parse(text); } catch { j = {}; }

                if (r.status === 409) {
                    const nro = j?.nroOrden || j?.otNroOrden;
                    if (nro) replaceBtnWithBadge(nro);
                    else await cargar();
                    showBanner("err", j?.message || "Este presupuesto ya tiene una OT asociada o falta se√±a.");
                    return;
                }

                if (!r.ok) {
                    showBanner("err", j?.message || `No se pudo crear la OT (HTTP ${r.status})`);
                    btn.dataset.busy = "0";
                    btn.disabled = false;
                    return;
                }

                const nro = j?.nroOrden;
                if (nro) {
                    replaceBtnWithBadge(nro);
                    showBanner("ok", `OT creada correctamente. N√∫mero: ${nro}`);
                } else {
                    showBanner("ok", "OT creada correctamente.");
                }

                // üîÅ recarga la tabla para que aparezca el bot√≥n Repuestos
                await cargar();
            } catch (e) {
                showBanner("err", "Error de red: " + (e?.message || e));
                btn.dataset.busy = "0";
                btn.disabled = false;
            }
            return;
        }
    });

    // ======= Generar presupuesto (con extras) =======
    document.getElementById("gen").addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const solicitudId = Number(fd.get("solicitudId"));
        const vehiculoTipo = fd.get("vehiculoTipo");
        const piezaTipo = fd.get("piezaTipo") || "MOTOR";
        const servicios = Array.from(selectedServices);
        const genErr = document.getElementById("genErr");

        const showError = (msg) => {
            genErr.classList.remove("d-none");
            genErr.textContent = msg;
        };

        genErr.classList.add("d-none");

        if (!solicitudId || Number.isNaN(solicitudId) || solicitudId <= 0) {
            return showError("Ingres√° un Solicitud ID v√°lido.");
        }

        if (!solicitudActual || Number(solicitudActual.id) !== solicitudId) {
            await cargarPiezaDesdeSolicitud(String(solicitudId));
        }

        if (!solicitudActual) {
            return showError("No se pudo leer la solicitud. Verific√° el ID.");
        }
        const marca  = (solicitudActual.marca  || "").trim();
        const modelo = (solicitudActual.modelo || "").trim();
        if (!marca && !modelo) {
            return showError("La solicitud no tiene marca / modelo cargados. Completalos antes de generar el presupuesto.");
        }

        const vehiculosValidos = ["CONVENCIONAL", "IMPORTADO"];
        if (!vehiculosValidos.includes(vehiculoTipo)) {
            return showError("Seleccion√° un tipo de veh√≠culo v√°lido.");
        }

        const piezasValidas = ["MOTOR", "TAPA"];
        if (!piezasValidas.includes(piezaTipo)) {
            return showError("Seleccion√° una pieza v√°lida (Motor o Tapa).");
        }

        const extras = Array.isArray(window.extras) ? window.extras.slice() : [];

        if (servicios.length === 0 && extras.length === 0) {
            return showError("Seleccion√° al menos un servicio o agreg√° un √≠tem extra.");
        }

        for (const ex of extras) {
            const nombre = (ex.nombre || "").trim();
            const precio = Number(ex.precio);
            if (!nombre) {
                return showError("Hay un servicio extra sin nombre. Corregilo antes de generar.");
            }
            if (!(precio > 0)) {
                return showError("Hay un servicio extra con precio inv√°lido (debe ser mayor a 0).");
            }
        }

        const payload = { solicitudId, vehiculoTipo, piezaTipo, servicios, extras };

        try {
            const r = await fetch("/presupuestos/generar", {
                method: "POST",
                headers: { "Content-Type": "application/json", ...getAuthHeader() },
                body: JSON.stringify(payload),
            });
            const j = await r.json().catch(() => ({}));
            if (!r.ok) throw new Error(j.message || "No se pudo generar");

            const ok = document.getElementById("genOk");
            ok.classList.remove("d-none");
            ok.textContent = "Generado presupuesto #" + j.id + " por " + money(j.total) + ".";
            genErr.classList.add("d-none");

            selectedServices.clear();
            window.extras = [];
            initServiciosForCurrentPieza();
            cargar();
        } catch (err) {
            showError(err.message);
        }
    });

    // ======= Interacciones UI =======
    document.addEventListener("click", (e) => {
        const chip = e.target.closest('button[data-chip="servicio"]');
        if (chip) return toggleChip(chip);

        const rm = e.target.closest('button[data-chip="extra-remove"]');
        if (rm) {
            const col = rm.closest('[data-extra-idx]');
            const idx = Number(col?.dataset?.extraIdx);
            if (!Number.isNaN(idx)) {
                window.extras.splice(idx, 1);
                renderExtrasChips();
            }
            return;
        }

        const extra = e.target.closest('button[data-chip="extra"]');
        if (extra) {
            const col = extra.closest('[data-extra-idx]');
            const idx = Number(col?.dataset?.extraIdx);
            if (!Number.isNaN(idx)) {
                window.extras.splice(idx, 1);
                renderExtrasChips();
            }
        }
    });

    document.getElementById("piezaMotor").addEventListener("change", initServiciosForCurrentPieza);
    document.getElementById("piezaTapa").addEventListener("change", initServiciosForCurrentPieza);

    document.getElementById("btnSrvOtro").addEventListener("click", () => {
        const nombre = (document.getElementById("srvOtro").value || "").trim();
        const precio = Number(document.getElementById("srvOtroPrecio").value);
        if (!nombre) return alert("Ingres√° un nombre de servicio.");
        if (!(precio > 0)) return alert("Ingres√° un precio v√°lido.");
        window.extras.push({ nombre, precio });
        renderExtrasChips();
        document.getElementById("srvOtro").value = "";
        document.getElementById("srvOtroPrecio").value = "";
    });

    document.getElementById("srvOtro").addEventListener("keydown", (e) => {
        if (e.key === "Enter") { e.preventDefault(); document.getElementById("btnSrvOtro").click(); }
    });

    const inpSid = document.querySelector('input[name="solicitudId"]');
    if (inpSid) {
        const go = () => cargarPiezaDesdeSolicitud(inpSid.value.trim());
        inpSid.addEventListener("change", go);
        inpSid.addEventListener("blur", go);
    }

    async function initAutofillFromQuery() {
        const qp = new URLSearchParams(location.search);
        const sid = qp.get("sid");
        if (!sid) return;
        await cargarPiezaDesdeSolicitud(sid);
        if (inpSid) inpSid.value = sid;
    }

    await initAutofillFromQuery();
    initServiciosForCurrentPieza();
    window.addEventListener("DOMContentLoaded", cargar);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>