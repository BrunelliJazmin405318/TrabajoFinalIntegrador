<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Reporte - Motores vs Tapas</title>

    <!-- Bootstrap + Icons + Chart.js -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        :root{
            --recti-red: #e53935;
            --recti-red-dark: #c62828;
            --recti-black: #111111;
            --recti-white: #ffffff;
            --recti-bg-light: #f3f3f3;
            --recti-card-light: #ffffff;

            /* Colores específicos de este reporte */
            --c-motor:#4e79a7;
            --c-tapa:#e15759;
        }

        * { box-sizing: border-box; }

        body{
            margin:0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--recti-bg-light) url("/img/fondo-figura.png") repeat;
            background-size:260px;
            color: var(--recti-black);
            min-height:100vh;
            display:flex;
            flex-direction:column;
        }

        /* ===== MINI NAV SUPERIOR ===== */
        .mini-nav{
            position:sticky;
            top:0;
            z-index:1100;
            background:rgba(255,255,255,0.92);
            backdrop-filter:blur(8px);
            border-bottom:1px solid rgba(0,0,0,0.05);
        }
        .mini-nav-inner{
            max-width:1200px;
            margin:0 auto;
            padding:.45rem 1rem;
            display:flex;
            justify-content:space-between;
            align-items:center;
            font-size:.85rem;
        }
        .mini-nav-left a{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:.25rem .7rem;
            border-radius:999px;
            border:1px solid rgba(0,0,0,0.08);
            background:#fff;
            text-decoration:none;
            color:#222;
        }
        .mini-nav-left a:hover{
            border-color:rgba(0,0,0,0.18);
        }
        .mini-nav-pill{
            padding:.25rem .7rem;
            border-radius:999px;
            background:#111;
            color:#f5f5f5;
            font-size:.8rem;
            display:inline-flex;
            align-items:center;
            gap:6px;
        }

        /* ===== PAGE WRAP ===== */
        main.page-wrap{
            max-width:1200px;
            margin:0 auto;
            padding:30px 16px 40px;
            flex:1 0 auto;
            width:100%;
        }

        .page-header{
            display:flex;
            flex-wrap:wrap;
            gap:10px;
            align-items:flex-end;
            justify-content:space-between;
            margin-bottom:14px;
        }
        .page-header-title h1{
            margin:0;
            font-size:1.9rem;
            font-weight:700;
            letter-spacing:.03em;
        }
        .page-header-title p{
            margin:4px 0 0;
            font-size:.95rem;
            color:#555;
        }
        .badge-report{
            background:var(--recti-red);
            color:#fff;
            padding:.35rem .75rem;
            border-radius:999px;
            font-size:.78rem;
            text-transform:uppercase;
            letter-spacing:.06em;
        }

        /* ===== CARD GENÉRICA ===== */
        .card{
            border-radius:16px;
            background:rgba(255,255,255,0.96);
            border:1px solid rgba(0,0,0,0.04);
            box-shadow:0 12px 30px rgba(0,0,0,0.08);
        }

        /* ===== FILTROS / TOOLBAR ===== */
        .toolbar .btn{ border-radius:.75rem; }
        .legend-dot{
            display:inline-block;
            width:10px;
            height:10px;
            border-radius:50%;
            margin-right:.3rem;
        }
        .legend-dot.motor{ background:var(--c-motor); }
        .legend-dot.tapa{  background:var(--c-tapa);  }

        /* ===== KPIs ===== */
        .kpi{
            min-height:110px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:1rem 1.25rem;
            border-radius:16px;
            background:rgba(255,255,255,0.96);
            border:1px solid rgba(0,0,0,0.04);
            box-shadow:0 10px 26px rgba(0,0,0,0.08);
        }
        .kpi h2{
            margin:0;
            font-weight:800;
            letter-spacing:.5px;
            color:#111;
        }
        .kpi .sub{
            font-size:.9rem;
            color:#555;
        }
        .pill{
            background:#111;
            color:#f5f5f5;
            border-radius:999px;
            padding:.25rem .7rem;
            font-size:.85rem;
        }

        .chart-wrap{
            padding:1rem 1.25rem 1.4rem;
        }

        .badge{
            font-size:.8rem;
            letter-spacing:.5px;
            vertical-align:middle;
        }

        .fade-in{ animation:fade .4s ease-out; }
        @keyframes fade{
            from{opacity:0; transform:translateY(2px);}
            to{opacity:1; transform:none;}
        }

        footer{
            font-size:.8rem;
            padding:12px 16px;
            text-align:center;
            color:#555;
            background:rgba(255,255,255,0.9);
            border-top:1px solid rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>

<!-- NAV SUPERIOR LIGHT -->
<div class="mini-nav">
    <div class="mini-nav-inner">
        <div class="mini-nav-left">
            <a href="/admin-menu.html">
                <i class="bi bi-arrow-left-short"></i>
                Volver al panel
            </a>
        </div>
        <div class="mini-nav-right">
            <span class="mini-nav-pill">
                <i class="bi bi-bar-chart-fill"></i> Reporte
            </span>
        </div>
    </div>
</div>

<main class="page-wrap">

    <!-- HEADER -->
    <div class="page-header">
        <div class="page-header-title">
            <h1>Motores vs Tapas</h1>
            <p>Comparativa de trabajos de motores y tapas en el período seleccionado.</p>
        </div>
        <div>
            <span class="badge-report">Dashboard</span>
        </div>
    </div>

    <!-- CONTROLES / FILTROS — VERSION UNIFICADA -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex flex-wrap gap-3 align-items-end">

                <!-- Desde -->
                <div>
                    <label class="form-label small mb-1">Desde</label>
                    <input id="fFrom" type="date" class="form-control form-control-sm">
                </div>

                <!-- Hasta -->
                <div>
                    <label class="form-label small mb-1">Hasta</label>
                    <input id="fTo" type="date" class="form-control form-control-sm">
                </div>

                <!-- Botonera derecha (rangos + acciones + exportar) -->
                <div class="ms-auto d-flex gap-2">

                    <!-- Rangos rápidos -->
                    <button id="r7" class="btn btn-outline-dark btn-sm">
                        Últimos 7 días
                    </button>

                    <button id="rMes" class="btn btn-outline-dark btn-sm">
                        Mes actual
                    </button>

                    <button id="rAnno" class="btn btn-outline-dark btn-sm">
                        Año actual
                    </button>

                    <!-- Aplicar -->
                    <button id="btnAplicar" class="btn btn-primary btn-sm">
                        <i class="bi bi-funnel"></i> Aplicar
                    </button>

                    <!-- Refresh -->
                    <button id="btnRefresh" class="btn btn-primary btn-sm">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>

                    <!-- Exportar (PDF / XLSX backend) -->
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-download"></i> Exportar
                        </button>
                        <ul class="dropdown-menu dropdown-menu-light">
                            <li><a class="dropdown-item" href="#" id="expPdf">PDF</a></li>
                            <li><a class="dropdown-item" href="#" id="expXlsx">Excel</a></li>
                        </ul>
                    </div>

                    <!-- CSV local -->
                    <button id="btnCsv"
                            class="btn btn-outline-dark btn-sm"
                            data-bs-toggle="tooltip"
                            title="Exportar resumen como CSV">
                        <i class="bi bi-filetype-csv"></i>
                    </button>

                    <!-- PNG local -->
                    <button id="btnPng"
                            class="btn btn-outline-dark btn-sm"
                            data-bs-toggle="tooltip"
                            title="Exportar ambos gráficos como PNG">
                        <i class="bi bi-image"></i>
                    </button>
                </div>
            </div>

            <!-- Texto de rango -->
            <p id="rangoActivo" class="text-secondary small mt-2 mb-0"></p>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
        <div class="col-sm-6 col-lg-3">
            <div class="kpi">
                <div>
                    <div class="sub">Motores</div>
                    <h2 id="kpiMotores">0</h2>
                </div>
                <span id="kpiMotoresPct" class="pill">0.0%</span>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="kpi">
                <div>
                    <div class="sub">Tapas</div>
                    <h2 id="kpiTapas">0</h2>
                </div>
                <span id="kpiTapasPct" class="pill">0.0%</span>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="kpi">
                <div>
                    <div class="sub">Total</div>
                    <h2 id="kpiTotal">0</h2>
                </div>
                <span class="pill">100%</span>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="kpi">
                <div>
                    <div class="sub">Ratio M/T</div>
                    <h2 id="kpiRatio">0</h2>
                </div>
                <span class="pill">motores/tapas</span>
            </div>
        </div>
    </div>

    <!-- GRÁFICOS -->
    <div class="row g-3">
        <div class="col-lg-5">
            <div class="card chart-wrap fade-in">
                <h6 class="mb-3 text-secondary">Distribución</h6>
                <canvas id="chartDonut" height="260"></canvas>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card chart-wrap fade-in">
                <h6 class="mb-3 text-secondary">Comparativa</h6>
                <canvas id="chartBar" height="260"></canvas>
            </div>
        </div>
    </div>

    <p id="lastRefresh" class="text-secondary small mt-3"></p>
</main>

<footer>
    © 2025 Rectificadora Cornejo — Reportes administrativos
</footer>

<script type="module">
    import { getAuthHeader } from "/js/auth.js";

    const ENDPOINT = "/api/reportes/motores-vs-tapas";
    const DEMO = { motores: 2, tapas: 1 };

    const $ = (id)=>document.getElementById(id);
    const cssVar = (name)=>getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    const fmtISO = d => d ? d.toISOString().slice(0,10) : "";
    const fmtPct = n => (isFinite(n) ? (n*100).toFixed(1) : "0.0") + "%";

    function setDefaultRange(){
        const to = new Date();
        const from = new Date(); from.setDate(to.getDate()-30);
        $("fFrom").value = fmtISO(from);
        $("fTo").value   = fmtISO(to);
    }

    function qsFromTo(){
        const from = $("fFrom").value;
        const to   = $("fTo").value;
        const p = new URLSearchParams();
        if (from) p.set("from", from);
        if (to)   p.set("to", to);
        $("rangoActivo").textContent = `Período: ${from || "-"} → ${to || "-"}`;
        const qs = p.toString();
        return qs ? "?"+qs : "";
    }

    function setKPIs(m, t){
        const total = m + t;
        const pm = total ? m/total : 0;
        const pt = total ? t/total : 0;
        const ratio = t ? (m/t).toFixed(2) : (m ? "∞" : "0");

        $("kpiMotores").textContent = m;
        $("kpiTapas").textContent   = t;
        $("kpiTotal").textContent   = total;
        $("kpiRatio").textContent   = ratio;

        $("kpiMotoresPct").textContent = fmtPct(pm);
        $("kpiTapasPct").textContent   = fmtPct(pt);
    }

    let donut, bar;
    function renderCharts(m, t){
        const labels = ["Motores", "Tapas"];
        const data = [m, t];
        const colors = [cssVar('--c-motor') || '#4e79a7', cssVar('--c-tapa') || '#e15759'];

        donut?.destroy(); bar?.destroy();

        donut = new Chart($("chartDonut"), {
            type: "doughnut",
            data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
            options: {
                animation: { animateRotate:true, animateScale:true, duration: 700 },
                plugins: {
                    legend: { position: "bottom", labels: { boxWidth: 10 } },
                    tooltip: { callbacks: { label: (ctx)=> `${ctx.label}: ${ctx.formattedValue}` } }
                },
                cutout: "60%"
            }
        });

        bar = new Chart($("chartBar"), {
            type: "bar",
            data: { labels, datasets: [{ label: "Órdenes", data, backgroundColor: colors, borderRadius: 8 }] },
            options: {
                animation: { duration: 700 },
                scales: {
                    x: { grid: { color:"#20262c" } },
                    y: { grid: { color:"#20262c" }, ticks: { precision:0, stepSize:1 }, beginAtZero:true }
                },
                plugins: { legend: { display:false } }
            }
        });
    }

    // Exportar PDF/XLSX (backend)
    function exportarMotoresVsTapas(fmt){
        const from = document.getElementById("fFrom").value || "";
        const to   = document.getElementById("fTo").value   || "";

        const params = new URLSearchParams();
        params.set("reporte", "motores-vs-tapas");
        params.set("format", fmt);

        if (from) params.set("from", from);
        if (to)   params.set("to", to);

        const url = "/api/reportes/export?" + params.toString();
        window.location.href = url;
    }

    document.getElementById("expPdf").addEventListener("click",  e=>{ e.preventDefault(); exportarMotoresVsTapas("pdf");  });
    document.getElementById("expXlsx").addEventListener("click", e=>{ e.preventDefault(); exportarMotoresVsTapas("xlsx"); });

    // Export locales
    function exportCSV(m, t){
        const total = m + t;
        const csv = [
            "tipo,cantidad,porcentaje",
            `MOTORES,${m},${total?((m/total)*100).toFixed(2):0}`,
            `TAPAS,${t},${total?((t/total)*100).toFixed(2):0}`
        ].join("\n");
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "reporte-motores-vs-tapas.csv";
        a.click();
        URL.revokeObjectURL(a.href);
    }
    function exportPNG(){
        const c1 = $("chartDonut");
        const c2 = $("chartBar");
        const combo = document.createElement("canvas");
        combo.width = Math.max(c1.width, c2.width);
        combo.height = c1.height + c2.height + 20;
        const ctx = combo.getContext("2d");
        ctx.drawImage(c1, 0, 0);
        ctx.drawImage(c2, 0, c1.height + 20);
        const a = document.createElement("a");
        a.href = combo.toDataURL("image/png");
        a.download = "motores-vs-tapas.png";
        a.click();
    }

    async function load(){
        const qs = qsFromTo();
        try {
            const r = await fetch(ENDPOINT + qs, {
                headers: { "Accept":"application/json", ...(getAuthHeader?.()||{}) }
            });
            if (!r.ok) throw new Error("HTTP " + r.status);
            const j = await r.json();

            console.log("DEBUG reporte motores vs tapas:", j);

            const m = Number(j.motores ?? 0);
            const t = Number(j.tapas   ?? 0);
            setKPIs(m, t);
            renderCharts(m, t);
        } catch (e){
            console.warn("Fetch falló, usando DEMO:", e);
            setKPIs(DEMO.motores, DEMO.tapas);
            renderCharts(DEMO.motores, DEMO.tapas);
        } finally {
            $("lastRefresh").textContent = "Actualizado: " + new Date().toLocaleString();
        }
    }

    // Eventos
    $("btnRefresh").addEventListener("click", load);
    $("btnCsv").addEventListener("click", ()=>{
        const m = Number($("kpiMotores").textContent || 0);
        const t = Number($("kpiTapas").textContent || 0);
        exportCSV(m, t);
    });
    $("btnPng").addEventListener("click", exportPNG);

    // Rangos rápidos
    $("r7").addEventListener("click", ()=>{
        const to = new Date(); const from = new Date(); from.setDate(to.getDate()-7);
        $("fFrom").value = fmtISO(from); $("fTo").value = fmtISO(to); load();
    });
    $("rMes").addEventListener("click", ()=>{
        const now = new Date(); const from = new Date(now.getFullYear(), now.getMonth(), 1);
        const to   = new Date(now.getFullYear(), now.getMonth()+1, 0);
        $("fFrom").value = fmtISO(from); $("fTo").value = fmtISO(to); load();
    });
    $("rAnno").addEventListener("click", ()=>{
        const now = new Date(); const from = new Date(now.getFullYear(),0,1);
        $("fFrom").value = fmtISO(from); $("fTo").value = fmtISO(now); load();
    });
    $("btnAplicar").addEventListener("click", load);

    setDefaultRange();
    load();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>