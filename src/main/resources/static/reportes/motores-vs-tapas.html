<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Reporte - Motores vs Tapas</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        :root{
            --c-bg:#0d1117;
            --c-card:#1a2230;      /* +claro que #161b22 */
            --c-soft:#2a3442;      /* +claro para contenedores/pills */
            --c-text:#f4f7fb;      /* texto principal +luminoso */
            --c-muted:#cbd6e2;     /* secundarios */
            --c-acc:#2f81f7;
            --c-motor:#4e79a7;
            --c-tapa:#e15759;
        }

        body{
            background:var(--c-bg);
            color:var(--c-text);
            font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,sans-serif;
        }

        .navbar{ background:#0b0f14; }

        .card{
            background:var(--c-card);
            border:none;
            border-radius:1rem;
            box-shadow:0 10px 30px rgba(0,0,0,.28);
        }

        .kpi{
            min-height:110px;
            display:flex; align-items:center; justify-content:space-between;
            padding:1rem 1.25rem;
        }
        .kpi h2{ margin:0; font-weight:800; letter-spacing:.5px; color:#ffffff; }
        .kpi .sub{ font-size:.9rem; color:var(--c-muted); }

        /* pills de % con más contraste */
        .pill{
            background:rgba(255,255,255,.14);
            color:#f4f7fb;
            border-radius:999px;
            padding:.25rem .6rem;
            font-size:.85rem;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
        }

        .toolbar .btn{ border-radius:.75rem }

        /* leyenda */
        .legend-dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:.35rem; }
        .legend-dot.motor{ background:var(--c-motor); }
        .legend-dot.tapa{  background:var(--c-tapa);  }

        .chart-wrap{ padding:1rem }

        .badge{ font-size:.8rem; letter-spacing:.5px; vertical-align:middle; }

        /* animación suave de aparición */
        .fade-in{ animation:fade .4s ease-out; }
        @keyframes fade{ from{opacity:0; transform:translateY(2px)} to{opacity:1; transform:none} }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#"><i class="bi bi-gear-fill me-2"></i>Rectificadora</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div id="nav" class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/reportes/motores-por-etapa.html">Motores por etapa</a></li>
                <li class="nav-item"><a class="nav-link active" href="/reportes/motores-vs-tapas.html">Motores vs Tapas</a></li>
                <li class="nav-item"><a class="nav-link" href="/swagger-ui.html" target="_blank">API Docs</a></li>
            </ul>
        </div>
    </div>
</nav>

<main class="container">
    <h2 class="mb-2">
        Motores vs Tapas <span class="badge bg-danger">Dashboard</span>
    </h2>
    <p id="rangoActivo" class="text-secondary small mb-3"></p>

    <!-- Controles -->
    <div class="d-flex flex-wrap gap-2 mb-3">
        <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
            <div class="btn-group" role="group" aria-label="rangos">
                <button id="r7"    class="btn btn-outline-secondary btn-sm">Últimos 7 días</button>
                <button id="rMes"  class="btn btn-outline-secondary btn-sm">Mes actual</button>
                <button id="rAnno" class="btn btn-outline-secondary btn-sm">Año actual</button>
            </div>

            <div class="ms-2 d-flex align-items-center gap-2">
                <input type="date" id="fFrom" class="form-control form-control-sm" style="width: 160px;">
                <span>→</span>
                <input type="date" id="fTo"   class="form-control form-control-sm" style="width: 160px;">
                <button id="btnAplicar" class="btn btn-primary btn-sm">
                    <i class="bi bi-funnel"></i> Aplicar
                </button>
            </div>
        </div>

        <button id="btnRefresh" class="btn btn-primary"><i class="bi bi-arrow-clockwise me-1"></i>Actualizar</button>
        <button id="btnPng" class="btn btn-outline-light"><i class="bi bi-image me-1"></i>Exportar PNG</button>
        <button id="btnCsv" class="btn btn-outline-light"><i class="bi bi-filetype-csv me-1"></i>Exportar CSV</button>

        <span class="ms-auto muted small d-flex align-items-center gap-3">
      <span><span class="legend-dot motor"></span>Motores</span>
      <span><span class="legend-dot tapa"></span>Tapas</span>
    </span>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
        <div class="col-sm-6 col-lg-3">
            <div class="card kpi shadow-soft">
                <div>
                    <div class="sub">Motores</div>
                    <h2 id="kpiMotores">0</h2>
                </div>
                <span id="kpiMotoresPct" class="pill">0.0%</span>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card kpi shadow-soft">
                <div>
                    <div class="sub">Tapas</div>
                    <h2 id="kpiTapas">0</h2>
                </div>
                <span id="kpiTapasPct" class="pill">0.0%</span>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card kpi shadow-soft">
                <div>
                    <div class="sub">Total</div>
                    <h2 id="kpiTotal">0</h2>
                </div>
                <span class="pill">100%</span>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card kpi shadow-soft">
                <div>
                    <div class="sub">Ratio M/T</div>
                    <h2 id="kpiRatio">0</h2>
                </div>
                <span class="pill">motores/tapas</span>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row g-3">
        <div class="col-lg-5">
            <div class="card shadow-soft chart-wrap">
                <h6 class="mb-3 text-secondary">Distribución</h6>
                <canvas id="chartDonut" height="260"></canvas>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card shadow-soft chart-wrap">
                <h6 class="mb-3 text-secondary">Comparativa</h6>
                <canvas id="chartBar" height="260"></canvas>
            </div>
        </div>
    </div>

    <p id="lastRefresh" class="text-secondary small mt-3"></p>
</main>

<script type="module">
    import { getAuthHeader } from "/js/auth.js";

    // ===== Config =====
    const ENDPOINT = "/api/reportes/motores-vs-tapas"; // espera {motores,tapas} (+ total, ratio opcional)
    const DEMO = { motores: 2, tapas: 1 };

    // ===== Helpers =====
    const $ = (id)=>document.getElementById(id);
    const cssVar = (name)=>getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    const fmtISO = d => d ? d.toISOString().slice(0,10) : "";
    const fmtPct = n => (isFinite(n) ? (n*100).toFixed(1) : "0.0") + "%";

    function setDefaultRange(){
        const to = new Date();
        const from = new Date(); from.setDate(to.getDate()-30);
        $("fFrom").value = fmtISO(from);
        $("fTo").value   = fmtISO(to);
    }

    function getRangeQS(){
        const from = $("fFrom").value;
        const to   = $("fTo").value;
        const p = new URLSearchParams();
        if (from) p.set("from", from);
        if (to)   p.set("to", to);
        $("rangoActivo").textContent = `Período: ${from || "-"} → ${to || "-"}`;
        const qs = p.toString();
        return qs ? "?"+qs : "";
    }

    // ===== KPIs =====
    function setKPIs(m, t){
        const total = m + t;
        const pm = total ? m/total : 0;
        const pt = total ? t/total : 0;
        const ratio = t ? (m/t).toFixed(2) : (m ? "∞" : "0");

        $("kpiMotores").textContent = m;
        $("kpiTapas").textContent   = t;
        $("kpiTotal").textContent   = total;
        $("kpiRatio").textContent   = ratio;

        $("kpiMotoresPct").textContent = fmtPct(pm);
        $("kpiTapasPct").textContent   = fmtPct(pt);
    }

    // ===== Charts =====
    let donut, bar;

    function renderCharts(m, t){
        const donutCtx = $("chartDonut");
        const barCtx   = $("chartBar");

        const labels = ["Motores", "Tapas"];
        const data = [m, t];
        const colors = [cssVar('--c-motor') || '#4e79a7', cssVar('--c-tapa') || '#e15759'];

        donut?.destroy(); bar?.destroy();

        donut = new Chart(donutCtx, {
            type: "doughnut",
            data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
            options: {
                animation: { animateRotate:true, animateScale:true, duration: 700 },
                plugins: {
                    legend: { position: "bottom", labels: { boxWidth: 10 } },
                    tooltip: { callbacks: { label: (ctx)=> `${ctx.label}: ${ctx.formattedValue}` } }
                },
                cutout: "60%"
            }
        });

        bar = new Chart(barCtx, {
            type: "bar",
            data: {
                labels,
                datasets: [{
                    label: "Órdenes",
                    data,
                    backgroundColor: colors,
                    borderRadius: 8
                }]
            },
            options: {
                animation: { duration: 700 },
                scales: {
                    x: { grid: { color:"#20262c" } },
                    y: { grid: { color:"#20262c" }, ticks: { precision:0, stepSize:1 }, beginAtZero:true }
                },
                plugins: { legend: { display:false } }
            }
        });
    }

    // ===== Export =====
    function exportCSV(m, t){
        const total = m + t;
        const csv = [
            "tipo,cantidad,porcentaje",
            `MOTORES,${m},${total?((m/total)*100).toFixed(2):0}`,
            `TAPAS,${t},${total?((t/total)*100).toFixed(2):0}`
        ].join("\n");
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "reporte-motores-vs-tapas.csv";
        a.click();
        URL.revokeObjectURL(a.href);
    }

    function exportPNG(){
        const c1 = $("chartDonut");
        const c2 = $("chartBar");
        const combo = document.createElement("canvas");
        combo.width = Math.max(c1.width, c2.width);
        combo.height = c1.height + c2.height + 20;
        const ctx = combo.getContext("2d");
        ctx.drawImage(c1, 0, 0);
        ctx.drawImage(c2, 0, c1.height + 20);
        const a = document.createElement("a");
        a.href = combo.toDataURL("image/png");
        a.download = "motores-vs-tapas.png";
        a.click();
    }

    // ===== Carga =====
    async function load(){
        const qs = getRangeQS();
        try {
            const r = await fetch(ENDPOINT + qs, { headers: { "Accept":"application/json", ...getAuthHeader?.() }});
            if (!r.ok) throw new Error("HTTP " + r.status);
            const j = await r.json();
            const m = Number(j.motores ?? 0);
            const t = Number(j.tapas   ?? 0);
            setKPIs(m, t);
            renderCharts(m, t);
        } catch (e){
            console.warn("Fetch falló, usando DEMO:", e);
            setKPIs(DEMO.motores, DEMO.tapas);
            renderCharts(DEMO.motores, DEMO.tapas);
        } finally {
            $("lastRefresh").textContent = "Actualizado: " + new Date().toLocaleString();
        }
    }

    // ===== Eventos =====
    $("btnRefresh").addEventListener("click", load);
    $("btnCsv").addEventListener("click", ()=>{
        const m = Number($("kpiMotores").textContent || 0);
        const t = Number($("kpiTapas").textContent || 0);
        exportCSV(m, t);
    });
    $("btnPng").addEventListener("click", exportPNG);

    // quick ranges
    $("r7").addEventListener("click", ()=>{
        const to = new Date(); const from = new Date(); from.setDate(to.getDate()-7);
        $("fFrom").value = fmtISO(from); $("fTo").value = fmtISO(to); load();
    });
    $("rMes").addEventListener("click", ()=>{
        const now = new Date(); const from = new Date(now.getFullYear(), now.getMonth(), 1);
        const to   = new Date(now.getFullYear(), now.getMonth()+1, 0);
        $("fFrom").value = fmtISO(from); $("fTo").value = fmtISO(to); load();
    });
    $("rAnno").addEventListener("click", ()=>{
        const now = new Date(); const from = new Date(now.getFullYear(),0,1);
        $("fFrom").value = fmtISO(from); $("fTo").value = fmtISO(now); load();
    });
    $("btnAplicar").addEventListener("click", load);

    // Init
    setDefaultRange();
    load();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>