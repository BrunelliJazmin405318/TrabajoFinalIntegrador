<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Reportes | Motores por etapa</title>

    <!-- Estilos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{
            --c-bg:#0d1117; --c-card:#161b22; --c-soft:#20262c; --c-text:#e6edf3;
            --c-acc:#2f81f7;
        }
        body{background:var(--c-bg); color:var(--c-text);}
        .navbar{background:#0b0f14;}
        .card{background:var(--c-card); border:none; border-radius:1rem;}
        .kpi{min-height:110px; display:flex; align-items:center; justify-content:space-between; padding:1rem 1.25rem;}
        .kpi h2{margin:0; font-weight:800; letter-spacing:.5px;}
        .kpi .sub{opacity:.8; font-size:.9rem}
        .pill{background:var(--c-soft); border-radius:999px; padding:.25rem .6rem; font-size:.85rem;}
        .toolbar .btn{border-radius:.75rem}
        .chart-wrap{padding:1rem}
        .shadow-soft{box-shadow:0 8px 30px rgba(0,0,0,.25);}

        /* üîπ Estilos agregados */
        body {
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }
        .badge {
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            vertical-align: middle;
        }
    </style>
</head>
<body>

<!-- NAV -->
<nav class="navbar navbar-dark">
    <div class="container py-2">
        <a class="navbar-brand d-flex align-items-center gap-2" href="/reportes/motores-vs-tapas.html">
            <i class="bi bi-gear-wide-connected"></i> <span>Rectificadora</span>
        </a>
        <button class="btn btn-outline-light btn-sm" onclick="location.href='/swagger-ui.html'">
            <i class="bi bi-box-arrow-up-right me-1"></i>API Docs
        </button>
    </div>
</nav>

<main class="container my-4">

    <!-- Title row -->
    <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
        <h2 class="mb-3">
            Reporte de Motores por Etapa
            <span class="badge bg-danger">Dashboard</span>
        </h2>
        <p class="text-secondary mb-4">
            Visualizaci√≥n de √≥rdenes de trabajo por etapa, filtradas por rango de fechas.
        </p>
        <span id="lastRefresh" class="text-secondary small">‚Äî</span>
    </div>

    <!-- Filtros -->
    <div class="card shadow-soft mb-4">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Desde</label>
                    <input id="fFrom" type="date" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Hasta</label>
                    <input id="fTo" type="date" class="form-control">
                </div>
                <div class="col-md-6">
                    <div class="d-flex flex-wrap gap-2 toolbar">
                        <button id="btnLast7" class="btn btn-outline-light"><i class="bi bi-calendar3 me-1"></i>√öltimos 7 d√≠as</button>
                        <button id="btnLast30" class="btn btn-outline-light">√öltimos 30 d√≠as</button>
                        <button id="btnYTD" class="btn btn-outline-light">YTD</button>
                        <button id="btnRefresh" class="btn btn-primary"><i class="bi bi-arrow-repeat me-1"></i>Actualizar</button>
                        <button id="btnPng" class="btn btn-outline-light"><i class="bi bi-image me-1"></i>Exportar PNG</button>
                        <button id="btnCsv" class="btn btn-outline-light"><i class="bi bi-filetype-csv me-1"></i>Exportar CSV</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- üîπ Texto que muestra el rango activo -->
    <p id="rangoActivo" class="text-secondary small mb-3"></p>
    <!-- KPIs -->
    <div class="row g-3 mb-4">
        <div class="col-sm-6 col-lg-3">
            <div class="card kpi">
                <div>
                    <div class="sub">Total motores</div>
                    <h2 id="kpiTotal">-</h2>
                </div>
                <span class="pill" id="kpiEtapas">- etapas</span>
            </div>
        </div>
        <div class="col-sm-6 col-lg-5">
            <div class="card kpi">
                <div>
                    <div class="sub">Etapa con m√°s motores</div>
                    <h2 id="kpiTopEtapa">-</h2>
                </div>
                <span class="pill" id="kpiTopValor">-</span>
            </div>
        </div>
        <div class="col-sm-12 col-lg-4">
            <div class="card kpi">
                <div>
                    <div class="sub">Leyenda</div>
                    <div class="d-flex align-items-center gap-3 mt-1">
            <span class="d-inline-flex align-items-center gap-2">
              <span class="badge rounded-pill" style="background:var(--c-acc)"> </span> Motores
            </span>
                        <span class="text-secondary">por etapa (barras)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="card shadow-soft">
        <div class="card-body chart-wrap">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="m-0">Distribuci√≥n por etapa</h5>
                <span class="text-secondary small">Bar chart</span>
            </div>
            <canvas id="chartEtapas" height="140"></canvas>
            <div id="emptyHint" class="text-center text-secondary mt-3 d-none">No hay datos para el rango seleccionado.</div>
        </div>
    </div>

</main>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script type="module">
    import { getAuthHeader } from "/js/auth.js";
    if (window.Chart && window.ChartDataLabels) {
        Chart.register(ChartDataLabels);
    }
    // ===== Config =====
    const ENDPOINT = "/api/reportes/motores-por-etapa"; // devuelve { etapas:[], cantidades:[], total }

    let chart;

    // ===== Helpers =====
    const fmtISO = d => d ? d.toISOString().slice(0,10) : "";

    function setDefaultsRange(){
        // √∫ltimo mes por defecto
        const to = new Date();
        const from = new Date(); from.setDate(to.getDate() - 30);
        document.getElementById("fFrom").value = fmtISO(from);
        document.getElementById("fTo").value   = fmtISO(to);
    }

    function setKpis(labels, values){
        const total = values.reduce((a,b)=>a+b,0);
        document.getElementById("kpiTotal").textContent = total;
        document.getElementById("kpiEtapas").textContent = `${labels.length} etapas`;

        let topIdx = -1, topVal = -1;
        values.forEach((v,i)=>{ if (v>topVal){ topVal=v; topIdx=i; }});
        document.getElementById("kpiTopEtapa").textContent = topIdx>=0 ? labels[topIdx] : "-";
        document.getElementById("kpiTopValor").textContent = topVal>0 ? `${topVal} motores` : "-";
    }

    function render(labels, values){
        const empty = (values.length===0) || values.every(v=>v===0);
        document.getElementById("emptyHint").classList.toggle("d-none", !empty);

        const ctx = document.getElementById("chartEtapas");
        chart?.destroy();
        chart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [{
                    label: "Motores",
                    data: values,
                    borderRadius: 10,
                    backgroundColor: "#2f80ed"
                }]
            },
            options: {
                animation: { duration: 700 },
                plugins: {
                    legend: { display:false },
                    // s√≥lo aplica si el plugin est√°
                    datalabels: window.ChartDataLabels ? {
                        anchor: 'end',
                        align: 'top',
                        formatter: (v)=> (v>0? v : ''),
                        color: '#e6edf3',
                        font: { weight:'700' }
                    } : undefined
                },
                scales: {
                    x: { grid: { color:"#20262c" } },
                    y: { beginAtZero:true, grid:{ color:"#20262c" }, ticks:{ precision:0, stepSize:1 } }
                }
            }
        });
    }

    async function load(){
        const from = document.getElementById("fFrom").value || "";
        const to   = document.getElementById("fTo").value   || "";

        // üü¢ Mostrar el rango activo arriba del gr√°fico
        document.getElementById("rangoActivo").innerHTML =
            `<i class="bi bi-calendar-event"></i> Per√≠odo: <strong>${from || "-"}</strong> ‚Üí <strong>${to || "-"}</strong>`;

        const params = new URLSearchParams();
        if (from) params.set("from", from);
        if (to)   params.set("to", to);
        const url = `${ENDPOINT}${params.toString() ? `?${params.toString()}` : ""}`;

        try{
            const r = await fetch(url, {
                headers: { Accept:"application/json", ...(getAuthHeader?.()||{}) }
            });
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            const j = await r.json();

            const labels = j.etapas || [];
            const values = (j.cantidades || []).map(Number);

            setKpis(labels, values);
            render(labels, values);
        }catch(e){
            console.warn("Error cargando reporte:", e);
            setKpis([], []);
            render([], []);
        }finally{
            document.getElementById("lastRefresh").textContent =
                "Actualizado: " + new Date().toLocaleString();
        }
    }

    // ===== Export =====
    document.getElementById("btnPng").addEventListener("click", ()=>{
        if (!chart) return;
        const a = document.createElement("a");
        a.href = chart.toBase64Image();
        a.download = "motores-por-etapa.png";
        a.click();
    });

    document.getElementById("btnCsv").addEventListener("click", ()=>{
        if (!chart) return;
        const L = chart.data.labels, V = chart.data.datasets[0].data;
        const csv = "Etapa,Cantidad\n" + L.map((l,i)=>`${l},${V[i]}`).join("\n");
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "motores-por-etapa.csv";
        a.click();
        URL.revokeObjectURL(a.href);
    });

    // ===== Atajos de rango =====
    const setRange = (days)=>{
        const to = new Date();
        const from = new Date(); from.setDate(to.getDate()-days);
        document.getElementById("fFrom").value = fmtISO(from);
        document.getElementById("fTo").value   = fmtISO(to);
        load();
    };
    document.getElementById("btnLast7").addEventListener("click", ()=>setRange(7));
    document.getElementById("btnLast30").addEventListener("click", ()=>setRange(30));
    document.getElementById("btnYTD").addEventListener("click", ()=>{
        const now = new Date();
        const from = new Date(now.getFullYear(),0,1);
        document.getElementById("fFrom").value = fmtISO(from);
        document.getElementById("fTo").value   = fmtISO(now);
        load();
    });

    document.getElementById("btnRefresh").addEventListener("click", load);

    // Init
    setDefaultsRange();
    load();
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</body>
</html>