<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin | Solicitudes de Presupuesto</title>
    <link rel="stylesheet" href="./css/styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--recti-bg-light) url("/img/fondo-figura.png") repeat;
            background-size: 260px;
            color: var(--recti-black);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== MINI NAV SUPERIOR ADMIN ===== */
        .mini-nav {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .mini-nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: .45rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: .85rem;
        }

        .mini-nav-left a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: .25rem .7rem;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,0.08);
            background: #fff;
            text-decoration: none;
            color: #222;
        }

        .mini-nav-left a i {
            font-size: 1.1rem;
        }

        .mini-nav-left a:hover {
            background: #f5f5f5;
        }

        .mini-nav-pill {
            padding: .25rem .7rem;
            border-radius: 999px;
            background: #111;
            color: white;
            font-size: .8rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* ===== PAGE WRAP ===== */
        main.page-wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 16px 40px;
            flex: 1 0 auto;
            width: 100%;
        }

        .page-header {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .page-header-left h1 {
            margin: 0;
            font-size: 1.9rem;
            font-weight: 700;
            letter-spacing: .03em;
        }

        .page-header-left p {
            margin: 4px 0 0;
            font-size: .95rem;
            color: #555;
        }

        .badge-admin {
            background: var(--recti-red);
            color: #fff;
            padding: .35rem .75rem;
            border-radius: 999px;
            font-size: .78rem;
            text-transform: uppercase;
            letter-spacing: .06em;
        }

        /* ===== CARDS ===== */
        .card {
            border-radius: 16px;
            background: rgba(255,255,255,0.96);
            border: 1px solid rgba(0,0,0,0.04);
            box-shadow: 0 12px 30px rgba(0,0,0,0.08);
        }

        .card-filters {
            margin-bottom: 16px;
            animation: fadeIn .4s ease-out;
        }

        .card-table {
            animation: fadeIn .5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ===== TABLE ===== */
        table.table thead th {
            font-size: .8rem;
            text-transform: uppercase;
            letter-spacing: .06em;
            color: #555;
            border-bottom-width: 1px;
        }

        table.table tbody td {
            font-size: .87rem;
            vertical-align: middle;
        }

        .table thead tr {
            background: #fafafa;
        }

        .table-hover > tbody > tr:hover > * {
            background-color: #f7f7f7;
        }

        /* ===== BANNERS ===== */
        #sucMsg, #errMsg {
            border-radius: 12px;
        }

        /* ===== BUTTONS / FILTERS ===== */
        #filtro {
            border-radius: 999px;
        }

        #btnBuscar {
            border-radius: 999px;
            background-color: var(--recti-red);
            border: none;
        }

        #btnBuscar:hover {
            background-color: var(--recti-red-dark);
        }

        /* ===== FOOTER ===== */
        footer.site-footer {
            border-top: 1px solid rgba(0,0,0,0.06);
            padding: 12px 16px;
            font-size: .8rem;
            color: #666;
            background: rgba(255,255,255,0.9);
        }

        footer .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* CARD QUE CONTIENE LA TABLA */
        .card-table {
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 12px 30px rgba(0,0,0,.12);
        }

        /* ÁREA DE TABLA SCROLLEABLE */
        .table-scroll {
            max-height: calc(100vh - 200px);
            min-height: 320px;
            overflow-y: auto;
        }

        /* HEADER DE LA TABLA FIJO */
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 5;
            background: #fafafa;
            color: #555;
        }

        /* === Columna de acciones compacta === */
        .col-acciones {
            white-space: nowrap;
            font-size: .8rem;
        }

        /* ===== Diseño columna ACCIONES (igual que Presupuestos) ===== */
        .acciones-stack {
            display: flex;
            flex-direction: column;
            gap: .35rem;
        }

        .acciones-stack .acciones-line {
            display: flex;
            flex-wrap: wrap;
            gap: .25rem;
            align-items: center;
        }

        .acciones-meta {
            font-size: .72rem;
            color: #666;
            display: flex;
            flex-wrap: wrap;
            gap: .25rem;
        }

        .acciones-pill {
            padding: .1rem .45rem;
            border-radius: 999px;
            background: #f3f3f3;
        }

        .acciones-pill--alert {
            background: #fff4d3;
            color: #7a5a00;
        }

        /* Botones redondos icon-only */
        .btn-icon-circle {
            width: 30px;
            height: 30px;
            border-radius: 999px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-color: #d0d0d0 !important;
        }

        .btn-icon-circle i {
            font-size: 1rem;
        }

        .acciones-stack .btn-icon-circle,
        .acciones-stack .btn-sm {
            border-color: #d0d0d0 !important;
            color: #555;
        }

        .acciones-stack .btn-icon-circle:hover,
        .acciones-stack .btn-sm:hover {
            background: var(--recti-red);
            color: #fff;
            border-color: var(--recti-red) !important;
        }
    </style>
</head>
<body>

<!-- MINI NAV SUPERIOR -->
<div class="mini-nav">
    <div class="mini-nav-inner">
        <div class="mini-nav-left">
            <a href="/admin-menu.html">
                <i class="bi bi-arrow-left-short"></i> Volver al panel
            </a>
        </div>
        <div class="mini-nav-right">
            <span class="mini-nav-pill">
                <i class="bi bi-inbox-fill"></i> Solicitudes
            </span>
        </div>
    </div>
</div>

<!-- CONTENT -->
<main class="page-wrap">
    <header class="page-header">
        <div class="page-header-left">
            <h1>Solicitudes de presupuesto</h1>
            <p>Revisá, aprobá o rechazá las solicitudes que entran desde la web.</p>
        </div>
        <div class="page-header-right">
            <span class="badge-admin">Panel admin</span>
        </div>
    </header>

    <!-- BANNERS (MISMA LÓGICA, SOLO ESTILO) -->
    <div id="sucMsg" class="alert alert-success d-none mb-3"></div>
    <div id="errMsg" class="alert alert-danger d-none mb-3"></div>

    <!-- FILTRO -->
    <div class="card card-filters mb-3">
        <div class="card-body">
            <h6 class="mb-3 text-uppercase text-muted" style="letter-spacing:.09em; font-size:.78rem;">
                Filtros del listado
            </h6>
            <div class="row g-2 align-items-end">
                <div class="col-md-4 col-12">
                    <label for="filtro" class="form-label small mb-1">Estado de la solicitud</label>
                    <select id="filtro" class="form-select">
                        <option value="" selected>Todas</option>
                        <option value="PENDIENTE" >Pendientes</option>
                        <option value="APROBADO">Aprobadas</option>
                        <option value="RECHAZADO">Rechazadas</option>
                    </select>
                </div>
                <div class="col-md-3 col-12 d-grid">
                    <button id="btnBuscar" class="btn btn-primary">
                        <i class="bi bi-search me-1"></i> Buscar
                    </button>
                </div>
                <div class="col-md-5 col-12 text-md-end mt-2 mt-md-0">
                    <small class="text-secondary">
                        Filtrá por estado de la solicitud.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLA -->
    <div class="card card-table">
        <div class="card-body p-0">

            <!-- Encabezado pequeño dentro de la card -->
            <div class="d-flex justify-content-between align-items-center p-3 pb-2">
                <h6 class="mb-0 text-uppercase text-muted" style="letter-spacing:.09em; font-size:.78rem;">
                    Listado de solicitudes
                </h6>
                <small class="text-secondary">ID, cliente, unidad, estado y acciones rápidas.</small>
            </div>

            <!-- Tabla scrolleable -->
            <div class="table-responsive table-scroll">
                <table class="table table-bordered table-hover align-middle mb-0">
                    <thead class="sticky-header">
                    <tr>
                        <th style="width:70px;">ID</th>
                        <th>Cliente</th>
                        <th>Teléfono</th>
                        <th>Unidad</th>
                        <th>Tipo consulta</th>
                        <th>Estado</th>
                        <th>Creada</th>
                        <th class="col-acciones" style="width:240px;">Acciones</th>
                    </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>

        </div>
    </div>
</main>

<footer class="site-footer">
    <div class="footer-inner">
        <span>© 2025 Rectificaciones Cornejo</span>
        <span>Panel administrativo</span>
    </div>
</footer>

<script type="module">
    import { getAuthHeader, isAuthenticated } from "/js/auth.js";

    /* =======================
       BANNERS
    ======================== */
    const suc = document.getElementById("sucMsg");
    const err = document.getElementById("errMsg");

    function showBannerOk(msg){
        suc.textContent = msg;
        suc.classList.remove("d-none");
        err.classList.add("d-none");
    }
    function showBannerErr(msg){
        err.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>${msg}`;
        err.classList.remove("d-none");
        suc.classList.add("d-none");
    }

    function badge(est){
        return est==='APROBADO' ? 'bg-success'
            : est==='RECHAZADO'? 'bg-danger'
                : 'bg-secondary';
    }

    async function cargar() {
        if (!isAuthenticated()) {
            alert("Iniciá sesión (admin) para ver esta pantalla.");
            location.href = "/login.html";
            return;
        }

        const estado = document.getElementById('filtro').value;
        const url = '/admin/presupuestos/solicitudes' + (estado ? `?estado=${encodeURIComponent(estado)}` : '');
        const r = await fetch(url, { headers: { ...getAuthHeader() }});
        const list = await r.json();

        const tb = document.getElementById('tbody');
        tb.innerHTML = '';

        list.forEach(s => {
            const puedeGenerar = (s.estado === 'APROBADO') && (s.presupuestoGenerado !== true);

            // Traducimos el tipo de consulta a algo lindo para la tabla
            let tipoConsultaLabel = '-';
            if (s.tipoConsulta === 'COTIZACION') {
                tipoConsultaLabel = 'Cotización estimada';
            } else if (s.tipoConsulta === 'DIAGNOSTICO') {
                tipoConsultaLabel = 'Diagnóstico presencial';
            } else if (s.tipoConsulta) {
                tipoConsultaLabel = s.tipoConsulta;
            }

            // ===== Acciones, con mismo estilo que Presupuestos =====
            let accionesHtml = "-";

            if (s.estado === "PENDIENTE") {
                accionesHtml = `
                <div class="acciones-stack">
                    <div class="acciones-meta">
                        <span class="acciones-pill acciones-pill--alert">Pendiente de revisión</span>
                    </div>
                    <div class="acciones-line">
                        <button class="btn btn-outline-secondary btn-sm btn-icon-circle"
                                data-act="aprobar" data-id="${s.id}"
                                title="Aprobar solicitud">
                            <i class="bi bi-check2"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm btn-icon-circle"
                                data-act="rechazar" data-id="${s.id}"
                                title="Rechazar solicitud">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            `;
            } else if (s.estado === "APROBADO") {
                if (puedeGenerar) {
                    // Aprobada, todavía sin presupuesto generado
                    accionesHtml = `
                    <div class="acciones-stack">
                        <div class="acciones-meta">
                            <span class="acciones-pill acciones-pill--alert">Sin presupuesto</span>
                        </div>
                        <div class="acciones-line">
                            <a class="btn btn-outline-secondary btn-sm btn-icon-circle"
                               href="/admin-presupuestos.html?sid=${s.id}"
                               title="Generar presupuesto">
                                <i class="bi bi-clipboard-plus"></i>
                            </a>
                        </div>
                    </div>
                `;
                } else {
                    // Aprobada y ya tiene presupuesto → solo info
                    accionesHtml = `
                    <div class="acciones-stack">
                        <div class="acciones-meta">
                            <span class="acciones-pill">Presupuesto generado</span>
                        </div>
                    </div>
                `;
                }
            } else if (s.estado === "RECHAZADO") {
                // Estado ya dice RECHAZADO, acá solo aclaramos que no hay acciones
                accionesHtml = `
                <div class="acciones-stack">
                    <div class="acciones-meta">
                        <span class="acciones-pill">Sin acciones disponibles</span>
                    </div>
                </div>
            `;
            }

            tb.insertAdjacentHTML('beforeend', `
                <tr>
                  <td>${s.id}</td>
                  <td>${s.clienteNombre}</td>
                  <td>${s.clienteTelefono || '-'}</td>
                  <td>${s.tipoUnidad} ${s.marca || ''} ${s.modelo || ''}</td>
                  <td>${tipoConsultaLabel}</td>
                  <td><span class="badge ${badge(s.estado)}">${s.estado}</span></td>
                  <td>${(s.creadaEn || '').replace('T',' ').substring(0,19)}</td>
                  <td>${accionesHtml}</td>
                </tr>
            `);
        });
    }

    document.getElementById('btnBuscar').addEventListener('click', cargar);

    document.getElementById('tbody').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;

        const id = btn.dataset.id;
        const act = btn.dataset.act;
        const nota = prompt(`${act.toUpperCase()}: nota/observación (opcional)`) || '';

        try {
            const r = await fetch(`/admin/presupuestos/solicitudes/${id}/${act}`, {
                method: 'PUT',
                headers: { ...getAuthHeader(), 'Content-Type':'application/json' },
                body: JSON.stringify({ nota })
            });

            const j = await r.json().catch(()=>({}));

            if (!r.ok) {
                showBannerErr(j.message || `Error HTTP ${r.status}`);
                return;
            }

            const accionHumana = act === "aprobar"
                ? "aprobada"
                : act === "rechazar"
                    ? "rechazada"
                    : act;

            showBannerOk(`Solicitud #${id} ${accionHumana} correctamente.`);
            cargar();

        } catch (e){
            showBannerErr("Error de red: " + (e?.message || e));
        }
    });

    // primera carga
    cargar();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>