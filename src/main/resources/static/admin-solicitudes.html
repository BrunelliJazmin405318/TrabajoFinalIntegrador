<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin | Solicitudes de Presupuesto</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!--    <link href="/css/styles.css" rel="stylesheet">-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --recti-red: #e53935;
            --recti-red-dark: #c62828;
            --recti-black: #111111;
            --recti-white: #ffffff;
            --recti-bg-light: #f3f3f3;
            --recti-card-light: #ffffff;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--recti-bg-light) url("/img/fondo-figura.png") repeat;
            background-size: 260px;
            color: var(--recti-black);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== MINI NAV SUPERIOR ADMIN ===== */
        .mini-nav {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .mini-nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: .45rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: .85rem;
        }

        .mini-nav-left a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: .25rem .7rem;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,0.08);
            background: #fff;
        }

        .mini-nav-pill {
            padding: .25rem .7rem;
            border-radius: 999px;
            background: #111;
            color: white;
            font-size: .8rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* ===== PAGE WRAP ===== */
        main.page-wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 16px 40px;
            flex: 1 0 auto;
            width: 100%;
        }

        .page-header {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .page-header-left h1 {
            margin: 0;
            font-size: 1.9rem;
            font-weight: 700;
            letter-spacing: .03em;
        }

        .page-header-left p {
            margin: 4px 0 0;
            font-size: .95rem;
            color: #555;
        }

        .badge-admin {
            background: var(--recti-red);
            color: #fff;
            padding: .35rem .75rem;
            border-radius: 999px;
            font-size: .78rem;
            text-transform: uppercase;
            letter-spacing: .06em;
        }

        /* ===== CARDS ===== */
        .card {
            border-radius: 16px;
            background: rgba(255,255,255,0.96);
            border: 1px solid rgba(0,0,0,0.04);
            box-shadow: 0 12px 30px rgba(0,0,0,0.08);
        }

        .card-filters {
            margin-bottom: 16px;
            animation: fadeIn .4s ease-out;
        }

        .card-table {
            animation: fadeIn .5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ===== TABLE ===== */
        table.table thead th {
            font-size: .8rem;
            text-transform: uppercase;
            letter-spacing: .06em;
            color: #555;
            border-bottom-width: 1px;
        }

        table.table tbody td {
            font-size: .87rem;
            vertical-align: middle;
        }

        .table thead tr {
            background: #fafafa;
        }

        .table-hover > tbody > tr:hover > * {
            background-color: #f7f7f7;
        }

        /* ===== BANNERS ===== */
        #sucMsg, #errMsg {
            border-radius: 12px;
        }

        /* ===== BUTTONS / FILTERS ===== */
        #filtro {
            border-radius: 999px;
        }

        #btnBuscar {
            border-radius: 999px;
            background-color: #c62828;
            border: none;
        }

        /* ===== FOOTER ===== */
        footer.site-footer {
            border-top: 1px solid rgba(0,0,0,0.06);
            padding: 12px 16px;
            font-size: .8rem;
            color: #666;
            background: rgba(255,255,255,0.9);
        }

        footer .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }
        /* CARD QUE CONTIENE LA TABLA */
        .card-table {
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 12px 30px rgba(0,0,0,.12);
        }

        /* ÁREA DE TABLA SCROLLEABLE */
        .table-scroll {
            max-height: 60vh;     /* límite de altura (60% pantalla) */
            overflow-y: auto;     /* scroll vertical */
        }

        /* HEADER DE LA TABLA FIJO */
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 5;
            background: #111;     /* mismo fondo que el nav oscuro */
            color: white;
        }
    </style>
</head>
<body>

<!-- MINI NAV SUPERIOR -->
<div class="mini-nav">
    <div class="mini-nav-inner">
        <div class="mini-nav-left">
            <a href="/admin-menu.html">
                <i class="bi bi-arrow-left-short"></i> Volver al panel
            </a>
        </div>
        <div class="mini-nav-right">
            <span class="mini-nav-pill">
                <i class="bi bi-inbox-fill"></i> Solicitudes
            </span>
        </div>
    </div>
</div>

<!-- CONTENT -->
<main class="page-wrap">
    <header class="page-header">
        <div class="page-header-left">
            <h1>Solicitudes de presupuesto</h1>
            <p>Revisá, aprobá o rechazá las solicitudes que entran desde la web.</p>
        </div>
        <div class="page-header-right">
            <span class="badge-admin">Panel admin</span>
        </div>
    </header>

    <!-- BANNERS (MISMA LÓGICA, SOLO ESTILO) -->
    <div id="sucMsg" class="alert alert-success d-none mb-3"></div>
    <div id="errMsg" class="alert alert-danger d-none mb-3"></div>

    <!-- FILTRO -->
    <div class="card card-filters mb-3">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label for="filtro" class="form-label small mb-1">Estado de la solicitud</label>
                    <select id="filtro" class="form-select">
                        <option value="">Todas</option>
                        <option value="PENDIENTE" selected>Pendientes</option>
                        <option value="APROBADO">Aprobadas</option>
                        <option value="RECHAZADO">Rechazadas</option>
                    </select>
                </div>
                <div class="col-md-3 d-grid">
                    <button id="btnBuscar" class="btn btn-primary">
                        <i class="bi bi-search me-1"></i> Buscar
                    </button>
                </div>
                <div class="col-md-5 text-md-end mt-2 mt-md-0">
                    <small class="text-secondary">
                        Filtrá por estado de la solicitud.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLA -->
    <div class="card card-table">
        <div class="card-body p-0">

            <!-- Encabezado pequeño dentro de la card -->
            <div class="d-flex justify-content-between align-items-center p-3 pb-2">
                <h6 class="mb-0 text-uppercase text-muted" style="letter-spacing:.09em; font-size:.78rem;">
                    Listado de solicitudes
                </h6>
                <small class="text-secondary">ID, cliente, unidad, estado y acciones rápidas.</small>
            </div>

            <!-- Tabla scrolleable -->
            <div class="table-responsive table-scroll">
                <table class="table table-bordered table-hover align-middle mb-0">
                    <thead class="sticky-header">
                    <tr>
                        <th style="width:70px;">ID</th>
                        <th>Cliente</th>
                        <th>Teléfono</th>
                        <th>Unidad</th>
                        <th>Tipo consulta</th>
                        <th>Estado</th>
                        <th>Creada</th>
                        <th style="width:240px;">Acciones</th>
                    </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>

        </div>
    </div>
</main>

<footer class="site-footer">
    <div class="footer-inner">
        <span>© 2025 Rectificadora Cornejo</span>
        <span>Panel administrativo — UTN FRC</span>
    </div>
</footer>

<script type="module">
    import { getAuthHeader, isAuthenticated } from "/js/auth.js";

    /* =======================
       BANNERS (NUEVO)
    ======================== */
    const suc = document.getElementById("sucMsg");
    const err = document.getElementById("errMsg");

    function showBannerOk(msg){
        suc.textContent = msg;
        suc.classList.remove("d-none");
        err.classList.add("d-none");
    }
    function showBannerErr(msg){
        err.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-2"></i>${msg}`;
        err.classList.remove("d-none");
        suc.classList.add("d-none");
    }

    /* ======================= */

    function badge(est){
        return est==='APROBADO' ? 'bg-success'
            : est==='RECHAZADO'? 'bg-danger'
                : 'bg-secondary';
    }

    async function cargar() {
        if (!isAuthenticated()) {
            alert("Iniciá sesión (admin) para ver esta pantalla.");
            location.href = "/login.html";
            return;
        }

        const estado = document.getElementById('filtro').value;
        const url = '/admin/presupuestos/solicitudes' + (estado ? `?estado=${encodeURIComponent(estado)}` : '');
        const r = await fetch(url, { headers: { ...getAuthHeader() }});
        const list = await r.json();

        const tb = document.getElementById('tbody');
        tb.innerHTML = '';

        list.forEach(s => {
            const puedeGenerar = (s.estado === 'APROBADO') && (s.presupuestoGenerado !== true);

            // Traducimos el tipo de consulta a algo lindo para la tabla
            let tipoConsultaLabel = '-';
            if (s.tipoConsulta === 'COTIZACION') {
                tipoConsultaLabel = 'Cotización estimada';
            } else if (s.tipoConsulta === 'DIAGNOSTICO') {
                tipoConsultaLabel = 'Diagnóstico presencial';
            } else if (s.tipoConsulta) {
                // fallback por si en BD hay otro texto
                tipoConsultaLabel = s.tipoConsulta;
            }

            const accionesHtml = `
                ${s.estado === 'PENDIENTE' ? `
                    <button class="btn btn-success btn-sm me-1" data-act="aprobar" data-id="${s.id}">
                      <i class="bi bi-check2"></i> Aprobar
                    </button>
                    <button class="btn btn-danger btn-sm me-2" data-act="rechazar" data-id="${s.id}">
                      <i class="bi bi-x-lg"></i> Rechazar
                    </button>
                ` : ''}

                ${s.estado === 'APROBADO' ? (
                puedeGenerar
                    ? `<a class="btn btn-outline-primary btn-sm"
                            href="/admin-presupuestos.html?sid=${s.id}">
                            <i class="bi bi-clipboard-plus"></i> Generar presupuesto
                         </a>`
                    : `<span class="badge bg-success">Presupuesto generado</span>`
            ) : ''}
            `;

            tb.insertAdjacentHTML('beforeend', `
                <tr>
                  <td>${s.id}</td>
                  <td>${s.clienteNombre}</td>
                  <td>${s.clienteTelefono || '-'}</td>
                  <td>${s.tipoUnidad} ${s.marca || ''} ${s.modelo || ''}</td>
                  <td>${tipoConsultaLabel}</td>
                  <td><span class="badge ${badge(s.estado)}">${s.estado}</span></td>
                  <td>${(s.creadaEn || '').replace('T',' ').substring(0,19)}</td>
                  <td>${accionesHtml}</td>
                </tr>
            `);
        });
    }

    document.getElementById('btnBuscar').addEventListener('click', cargar);

    document.getElementById('tbody').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;

        const id = btn.dataset.id;
        const act = btn.dataset.act;
        const nota = prompt(`${act.toUpperCase()}: nota/observación (opcional)`) || '';

        try {
            const r = await fetch(`/admin/presupuestos/solicitudes/${id}/${act}`, {
                method: 'PUT',
                headers: { ...getAuthHeader(), 'Content-Type':'application/json' },
                body: JSON.stringify({ nota })
            });

            const j = await r.json().catch(()=>({}));

            if (!r.ok) {
                showBannerErr(j.message || `Error HTTP ${r.status}`);
                return;
            }

            showBannerOk(`Solicitud #${id} ${act} correctamente.`);
            cargar();

        } catch (e){
            showBannerErr("Error de red: " + (e?.message || e));
        }
    });

    // primera carga
    cargar();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>