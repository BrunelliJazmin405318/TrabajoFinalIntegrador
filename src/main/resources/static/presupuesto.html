<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Solicitar presupuesto | Rectificadora</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<!-- NAV -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="/presupuesto.html"><i class="bi bi-gear-fill me-2"></i>Rectificadora</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-label="Menu">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div id="nav" class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" href="/presupuesto.html">Solicitar presupuesto</a></li>
                <li class="nav-item"><a class="nav-link" href="/estado-solicitud.html">Estado de solicitud</a></li>
                <li class="nav-item"><a class="nav-link" href="/admin-solicitud.html">Admin</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- CONTENT -->
<main class="container page-wrap">
    <div class="page-title">
        <h1 class="m-0">Solicitar presupuesto</h1>
        <span class="badge">Presupuestos</span>
    </div>

    <form id="formSolicitud" class="row g-3">
        <div class="col-md-6">
            <label class="form-label">Nombre y Apellido*</label>
            <input class="form-control" name="clienteNombre" required>
        </div>
        <div class="col-md-6">
            <label class="form-label">Teléfono</label>
            <input class="form-control" name="clienteTelefono" placeholder="+54 9 ...">
        </div>
        <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="clienteEmail" placeholder="ejemplo@correo.com">
        </div>
        <div class="col-md-6">
            <label class="form-label">Tipo de unidad*</label>
            <select class="form-select" name="tipoUnidad" required>
                <option value="MOTOR">Motor</option>
                <option value="TAPA">Tapa</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Marca</label>
            <input class="form-control" name="marca" placeholder="Ej: Fiat">
        </div>
        <div class="col-md-4">
            <label class="form-label">Modelo</label>
            <input class="form-control" name="modelo" placeholder="Ej: Palio">
        </div>
        <div class="col-md-4">
            <label class="form-label">Cilindrada de motor</label>
            <input class="form-control" name="nroMotor" placeholder="Ej:1.6 - 2.0">
        </div>
        <div class="col-12 bg-dark p-3 rounded-3">
            <label class="form-label d-block">¿Qué necesitás?</label>

            <div class="form-check form-check-inline">
                <input class="form-check-input"
                       type="radio"
                       name="tipoConsulta"
                       id="tipoCoti"
                       value="COTIZACION"
                       checked>
                <label class="form-check-label" for="tipoCoti">
                    Cotización estimada
                </label>
            </div>

            <div class="form-check form-check-inline">
                <input class="form-check-input"
                       type="radio"
                       name="tipoConsulta"
                       id="tipoDiag"
                       value="DIAGNOSTICO">
                <label class="form-check-label" for="tipoDiag">
                    No sé qué tiene / Quiero diagnóstico presencial
                </label>
            </div>

            <div class="form-text">
                Si elegís diagnóstico presencial, te vamos a contactar para coordinar un turno y ver la pieza en el taller.
            </div>
        </div>
        <div class="col-12">
            <label class="form-label">Descripción del trabajo</label>
            <textarea class="form-control" name="descripcion" rows="3"
                      placeholder="Contanos qué le pasa al motor / tapa, ruidos, síntomas, etc."></textarea>
        </div>
        <div class="col-12 d-grid">
            <button class="btn btn-primary btn-lg" type="submit">Enviar solicitud</button>
        </div>
    </form>

    <div id="ok" class="alert alert-success mt-4 d-none"></div>
    <div id="err" class="alert alert-danger mt-4 d-none"></div>
</main>

<footer class="site-footer">
    <div class="container d-flex justify-content-between">
        <span>© Rectificadora Cornejo</span>
        <span class="muted">Universidad Tecnologica Nacional</span>
    </div>
</footer>

<script>
    const f = document.getElementById('formSolicitud');

    // ============== HELPERS UI ==============
    function mostrarError(msg) {
        const el = document.getElementById('err');
        el.classList.remove('d-none');
        el.innerHTML = msg;
        document.getElementById('ok').classList.add('d-none');
    }

    function mostrarOK(msg) {
        const ok = document.getElementById('ok');
        ok.classList.remove('d-none');
        ok.innerHTML = msg;
        document.getElementById('err').classList.add('d-none');
    }

    // ============== VALIDACIONES AVANZADAS ==============

    // Solo letras, números y espacios (para marca / modelo)
    function validarTextoSimple(v) {
        if (!v) return true; // vacío lo permitimos
        return /^[A-Za-z0-9ÁÉÍÓÚáéíóúñÑ ]+$/.test(v);
    }

    // Validación de EMAIL MX (dominio real)
    async function validarEmailMX(email) {
        if (!email || !email.includes('@')) return false;
        const domain = email.split('@')[1].toLowerCase();
        try {
            const resp = await fetch(`https://cloudflare-dns.com/dns-query?name=${domain}&type=MX`, {
                headers: { 'Accept': 'application/dns-json' }
            });
            const data = await resp.json();
            // Si hay registros MX, consideramos que el dominio es válido
            return Array.isArray(data.Answer);
        } catch {
            // Si falla la consulta DNS, no bloqueamos el submit
            return true;
        }
    }

    // Normalizar teléfono → formato apto WhatsApp +549XXXXXXXXXX
    function normalizarTelefono(t) {
        if (!t) return "";
        // sacar todo lo que no sea número
        t = t.replace(/[^0-9]/g, "");

        // ya viene como 549XXXXXXXXXX
        if (t.startsWith("549")) return "+" + t;

        // arranca con 54 → agregamos 9 para móvil
        if (t.startsWith("54")) return "+549" + t.slice(2);

        // si son 10 dígitos (ej: 3512223333) → +549 + esos 10
        if (t.length === 10) return "+549" + t;

        // si son 11 y empiezan con 9 → +54 + resto
        if (t.length === 11 && t.startsWith("9")) return "+54" + t;

        // fallback: lo mandamos como +549 + lo que puso
        return "+549" + t;
    }

    // ============== SUBMIT FORMULARIO ==============
    f.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(f).entries());

        // ---- Normalizar teléfono a formato WhatsApp-friendly ----
        if (data.clienteTelefono) {
            data.clienteTelefono = normalizarTelefono(data.clienteTelefono);
        }

        // ---- Marca / Modelo: solo letras, números y espacios ----
        if (data.marca && !validarTextoSimple(data.marca)) {
            return mostrarError("La marca solo puede contener letras, números y espacios.");
        }
        if (data.modelo && !validarTextoSimple(data.modelo)) {
            return mostrarError("El modelo solo puede contener letras, números y espacios.");
        }

        // ---- Validar email + MX si cargó uno ----
        if (data.clienteEmail) {
            // valida formato básico HTML5 (type=email) + dominio MX
            if (!f.clienteEmail.checkValidity()) {
                return mostrarError("Ingresá un email válido (ej: usuario@dominio.com).");
            }
            const okMX = await validarEmailMX(data.clienteEmail);
            if (!okMX) {
                return mostrarError("El dominio del email no existe. Revisá el correo (ej: gmail.com, yahoo.com).");
            }
        }

        // ---- Enviar solicitud al backend ----
        try {
            const resp = await fetch('/public/presupuestos/solicitud', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(data)
            });
            const payload = await resp.json().catch(()=>({}));
            if (!resp.ok) throw new Error(payload?.message || 'No se pudo enviar');

            mostrarOK(
                `Solicitud enviada ✅. Número: <strong>${payload.id}</strong>. ` +
                `Podés ver el estado <a href="/estado-solicitud.html?id=${payload.id}">acá</a>.`
            );
            f.reset();
        } catch (err) {
            mostrarError(err.message);
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>